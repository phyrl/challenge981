<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>è˜‹æœçš„è€ƒé©— V0.6.2</title>
<style>
    :root { --accent: #e74c3c; --gold: #f1c40f; --bg: #0f0f0f; --panel: rgba(255, 255, 255, 0.08); }
    body { margin: 0; background: var(--bg); color: white; font-family: 'Segoe UI', Arial, sans-serif; overflow: hidden; touch-action: none; }
    #gameContainer { position: relative; width: 100vw; height: 100vh; background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%); }
    canvas { display: block; width: 100%; height: 100%; }

    /* UI é ‚éƒ¨èˆ‡æš«åœ */
    #ui { position: absolute; top: 12px; left: 15px; right: 15px; display: flex; justify-content: space-between; align-items: center; z-index: 50; pointer-events: none; }
    .ui-item { background: rgba(0,0,0,0.5); padding: 5px 12px; border-radius: 20px; font-weight: bold; border: 1px solid rgba(255,255,255,0.2); }
    #pauseBtn { pointer-events: auto; cursor: pointer; background: var(--accent); border: none; color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; transition: 0.2s; }
    #pauseBtn:hover { transform: scale(1.1); box-shadow: 0 0 10px var(--accent); }

    /* å…¬å¼é¡¯ç¤º */
    #equationHeader { position: absolute; top: 60px; left: 0; right: 0; text-align: center; z-index: 40; pointer-events: none; }
    #targetEquation { font-size: clamp(18px, 5vw, 34px); font-weight: bold; color: var(--gold); background: rgba(0,0,0,0.8); padding: 15px 25px; border-radius: 20px; display: inline-block; min-width: 80%; border: 2px solid rgba(241, 196, 15, 0.3); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .next-char { color: #fff; text-decoration: underline; text-underline-offset: 8px; animation: blink 0.8s infinite; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

    /* é€šç”¨ Overlay */
    .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; z-index: 100; padding: 25px; box-sizing: border-box; backdrop-filter: blur(5px); }
    .hidden { display: none !important; }

    /* ä¸»é¸å–®ç¾åŒ– */
    h1.title { font-size: clamp(36px, 10vw, 56px); margin: 0; color: var(--accent); text-shadow: 0 0 20px rgba(231, 76, 60, 0.5); animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03); } }
    .menu-card { background: var(--panel); border: 1px solid rgba(255,255,255,0.1); padding: 25px; border-radius: 25px; width: 90%; max-width: 450px; margin-top: 20px; }
    
    .btn-main { padding: 15px 45px; font-size: 22px; cursor: pointer; border: none; border-radius: 50px; background: var(--accent); color: white; font-weight: bold; margin: 10px; transition: 0.3s; box-shadow: 0 5px 20px rgba(231, 76, 60, 0.4); }
    .btn-main:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(231, 76, 60, 0.6); }
    .btn-sub { background: #34495e; font-size: 16px; padding: 10px 25px; }

    /* å€’æ•¸èˆ‡é‡‘å¥ */
    #countdownDisplay { font-size: 100px; font-weight: bold; color: var(--accent); text-shadow: 0 0 30px var(--accent); pointer-events: none; z-index: 200; }
    .quote-box { animation: quoteFade 4s forwards; }
    @keyframes quoteFade { 0% { opacity:0; transform:scale(0.95); } 20% { opacity:1; transform:scale(1); } 80% { opacity:1; } 100% { opacity:0; } }

    /* æ’è¡Œæ¦œèˆ‡åˆ†äº« */
    #statsTable { width: 100%; max-width: 320px; border-collapse: collapse; margin: 20px 0; }
    #statsTable td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    #qrcode { background: white; padding: 8px; border-radius: 10px; margin: 15px 0; }

    /* æµ®å‹•è¨Šæ¯ */
    .float-msg { position: absolute; pointer-events: none; font-weight: bold; animation: floatUp 1s forwards; z-index: 60; }
    @keyframes floatUp { from { opacity:1; transform:translateY(0); } to { opacity:0; transform:translateY(-60px); } }
</style>
</head>
<body>

<div id="gameContainer">
    <div id="ui">
        <div class="ui-item" id="levelDisplay">é—œå¡: 1/4</div>
        <div class="ui-item" id="timeDisplay" style="width: 100px;">19.62s</div>
        <button id="pauseBtn" onclick="togglePause()">â¸ æš«åœ</button>
    </div>

    <div id="equationHeader"><div id="targetEquation">æº–å‚™æŒ‘æˆ°...</div></div>
    <div id="countdownDisplay" class="hidden"></div>
    <div id="msgContainer"></div>
    <canvas id="gameCanvas"></canvas>

    <div id="mainMenu" class="overlay">
        <h1 class="title">ğŸ è˜‹æœçš„è€ƒé©—</h1>
        <p style="color:var(--gold); letter-spacing: 2px;">ç ”ç¿’ç‰©ç†ï¼Œéœ€å¿ƒç„¡æ—é¶©ã€‚</p>
        
        <div class="menu-card">
            <input type="text" id="playerName" maxlength="10" placeholder="è¼¸å…¥å­¸éœ¸åå­—" style="width: 80%; padding: 12px; border-radius: 10px; border: none; font-size: 18px; text-align: center; margin-bottom: 20px;">
            <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 20px;">
                <label><input type="radio" name="diff" value="0" checked> é›£åº¦ 0</label>
                <label><input type="radio" name="diff" value="9.81"> é›£åº¦ 9.81</label>
                <label><input type="radio" name="diff" value="19.62"> é›£åº¦ 19.62</label>
            </div>
            <div style="margin-bottom: 10px;">
                <button id="soundBtn" class="btn-main btn-sub" onclick="toggleSound()">ğŸ”Š è²æ•ˆ: ON</button>
            </div>
            <button class="btn-main" onclick="startLevel(0)">é–‹å§‹æŒ‘æˆ°</button>
            <button class="btn-main btn-sub" onclick="showRules(true)">è©³ç´°è¦å‰‡</button>
        </div>
    </div>

    <div id="rulesOverlay" class="overlay hidden">
        <div class="menu-card" style="text-align: left;">
            <h2 style="color:var(--gold); text-align: center;">ğŸ“œ å¯¦é©—æŒ‡å¼•</h2>
            â€¢ <b>ç›®æ¨™ï¼š</b>ä¾åºæ¥å–æ­£ç¢ºç¬¦è™Ÿå®Œæˆ 4 æ¢ç‰©ç†å…¬å¼ã€‚<br>
            â€¢ <b>è¨ˆæ™‚ï¼š</b>æ¯é—œ 19.62sã€‚æ­£ç¢º +0.5sï¼Œâ° +3sã€‚<br>
            â€¢ <b>é€£æ“Šï¼š</b>é€£çºŒæ¥ä¸­ 5 å€‹ï¼Œè˜‹æœç™¼å…‰ä¸¦é€²å…¥å€ç‡çå‹µã€‚<br>
            â€¢ <b>æ‡²ç½°ï¼š</b>æ¥éŒ¯æœƒæ‰£æ™‚ã€‚é«˜é›£åº¦ä¸‹æ¥éŒ¯æœƒ Reset å…¬å¼ã€‚<br>
            â€¢ <b>æ“ä½œï¼š</b>â† / â†’ æ…¢é€Ÿå¾®èª¿ï¼›æŒ‰ä½ <b>Shift</b> è¡åˆºã€‚
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn-main btn-sub" onclick="showRules(false)">è¿”å›ä¸»é </button>
            </div>
        </div>
    </div>

    <div id="pauseOverlay" class="overlay hidden">
        <h1 style="color:var(--gold)">PAUSE</h1>
        <p>å¯¦é©—æš«åœä¸­ï¼Œæ·±å‘¼å¸...</p>
        <button class="btn-main" onclick="togglePause()">æ¢å¾©å¯¦é©—</button>
    </div>

    <div id="resultOverlay" class="overlay hidden">
        <h1 id="resultHeader" style="color:var(--gold)">ğŸ† å¯¦é©—æˆåŠŸ</h1>
        <table id="statsTable"></table>
        <h2 id="totalScoreText" style="color:var(--accent)"></h2>
        <div id="shareArea">
            <img id="qrcode" src="" alt="QR">
            <br>
            <button class="btn-main btn-sub" id="waShare">WhatsApp åˆ†äº«</button>
        </div>
        <button class="btn-main" onclick="exitToHome()">å®Œæˆä¸¦è¿”å›</button>
    </div>

    <div id="quoteOverlay" class="overlay hidden">
        <div class="quote-box">
            <div class="quote-text">ã€Œç ”ç¿’ç‰©ç†ï¼Œéœ€å¿ƒç„¡æ—é¶©ã€‚ã€</div>
            <div class="quote-text" style="font-size: 0.8em; opacity: 0.8;">ã€Œå¬‰æˆ²ä¹‹æ™‚ï¼Œè«å¿˜æ¢ç´¢çœŸç†ã€‚ã€</div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDoHHh-8Gm5tt_uWF4IPGIGfOTNYnAgHr4",
      authDomain: "physicsgame-rl.firebaseapp.com",
      projectId: "physicsgame-rl",
      storageBucket: "physicsgame-rl.firebasestorage.app",
      messagingSenderId: "68402923149",
      appId: "1:68402923149:web:0bb2be531b9e971a6544c4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const formulas = [['v', '=', 'u', '+', 'a', 't'], ['s', '=', 'Â½', '(', 'u', '+', 'v', ')', 't'], ['s', '=', 'u', 't', '+', 'Â½', 'a', 't', 'Â²'], ['v', 'Â²', '=', 'u', 'Â²', '+', '2', 'a', 's']];
    
    let isPlaying = false, isPaused = false, currentLevel = 0, currentCharIdx = 0;
    let startTime, timeBonus = 0, levelTimes = [0,0,0,0], objects = [], combo = 0;
    let soundOn = true, audioCtx = null, currentDiff = 0;
    const player = { x: 0, y: 0, size: 65 };
    const keys = { left: false, right: false, shift: false };

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; player.x = canvas.width/2; player.y = canvas.height - 110; }
    window.addEventListener('resize', resize); resize();

    // è²æ•ˆèˆ‡éŸ³æ•ˆ
    function playB(f, d, vol=0.05) {
        if (!soundOn || !audioCtx) return;
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.frequency.setValueAtTime(f, audioCtx.currentTime);
        g.gain.setValueAtTime(vol, audioCtx.currentTime);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + d);
    }

    window.toggleSound = () => { soundOn = !soundOn; document.getElementById('soundBtn').innerText = soundOn ? "ğŸ”Š è²æ•ˆ: ON" : "ğŸ”‡ è²æ•ˆ: OFF"; };
    window.showRules = (s) => document.getElementById('rulesOverlay').classList.toggle('hidden', !s);
    
    window.togglePause = () => {
        if (!isPlaying) return;
        isPaused = !isPaused;
        document.getElementById('pauseOverlay').classList.toggle('hidden', !isPaused);
        if (!isPaused) { startTime = Date.now() - (lastRemain * 1000); requestAnimationFrame(gameLoop); }
    };

    window.addEventListener('keydown', e => { 
        if(e.key==='ArrowLeft') keys.left=true; if(e.key==='ArrowRight') keys.right=true; if(e.key==='Shift') keys.shift=true;
    });
    window.addEventListener('keyup', e => { 
        if(e.key==='ArrowLeft') keys.left=false; if(e.key==='ArrowRight') keys.right=false; if(e.key==='Shift') keys.shift=false;
    });

    // ğŸŒŸ é—œå¡é–‹å§‹å„€å¼
    window.startLevel = async (idx) => {
        if (!audioCtx) audioCtx = new AudioContext();
        currentDiff = parseFloat(document.querySelector('input[name="diff"]:checked').value);
        document.getElementById('mainMenu').classList.add('hidden');
        
        isPlaying = false; isPaused = false;
        objects = []; currentLevel = idx; currentCharIdx = 0; timeBonus = 0; combo = 0;
        document.getElementById('levelDisplay').innerText = `é—œå¡: ${idx + 1}/4`;
        
        const co = document.getElementById('countdownDisplay');
        co.classList.remove('hidden');
        const steps = [`ç¬¬ ${idx+1} é—œ`, "READY?", "3", "2", "1", "GO!"];
        for (let s of steps) {
            co.innerText = s;
            playB(s==="GO!"?800:440, 0.1);
            await new Promise(r => setTimeout(r, 700));
        }
        co.classList.add('hidden');
        
        startTime = Date.now();
        isPlaying = true;
        updateUI();
        gameLoop();
    };

    let lastRemain = 19.62;
    function gameLoop() {
        if (!isPlaying || isPaused) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const remain = Math.max(0, 19.62 + timeBonus - (Date.now() - startTime)/1000);
        lastRemain = remain;
        const timeEl = document.getElementById('timeDisplay');
        timeEl.innerText = `${remain.toFixed(2)}s`;
        
        // ç·Šå¼µéŸ³æ•ˆ
        if (remain < 3.0 && Math.floor(remain * 10) % 10 === 0) { 
            timeEl.style.color = 'var(--accent)'; playB(1200, 0.05, 0.02); 
        } else { timeEl.style.color = 'white'; }

        if (remain <= 0) { isPlaying = false; alert("æ™‚é–“åˆ°ï¼é‡è©¦è©²é—œã€‚"); startLevel(currentLevel); return; }

        // ç§»å‹•
        const spd = keys.shift ? canvas.width * 0.035 : canvas.width * 0.007;
        if (keys.left) player.x -= spd; if (keys.right) player.x += spd;
        player.x = Math.max(30, Math.min(canvas.width-30, player.x));

        // ç•«è˜‹æœ
        ctx.font = "60px Arial"; ctx.textAlign = "center";
        if (combo >= 5) { ctx.shadowBlur = 25; ctx.shadowColor = "var(--gold)"; }
        ctx.fillText(combo>=5?"ğŸŒŸ":"ğŸ", player.x, player.y);
        ctx.shadowBlur = 0;

        // ç‰©ä»¶
        for (let i = objects.length - 1; i >= 0; i--) {
            const o = objects[i]; o.y += o.speed;
            ctx.font = "bold 40px Arial";
            ctx.fillStyle = (o.char === formulas[currentLevel][currentCharIdx]) ? "var(--gold)" : "white";
            ctx.fillText(o.char, o.x, o.y);

            if (Math.abs(player.x - o.x) < 45 && Math.abs(player.y - o.y) < 45) {
                catchObj(o); objects.splice(i, 1);
            } else if (o.y > canvas.height + 50) objects.splice(i, 1);
        }

        if (Math.random() < 0.06) spawn();
        requestAnimationFrame(gameLoop);
    }

    function spawn() {
        const f = formulas[currentLevel];
        let char = (Math.random() < 0.65) ? f[currentCharIdx] : (Math.random()<0.1?'â°':'X');
        objects.push({ char, x: Math.random()*canvas.width, y: -50, speed: 4 + Math.random()*3 });
    }

    function catchObj(o) {
        if (o.char === 'â°') { timeBonus += 3; msg("+3s", "var(--gold)"); playB(900, 0.1); return; }
        if (o.char === formulas[currentLevel][currentCharIdx]) {
            currentCharIdx++; combo++; timeBonus += 0.5;
            msg("+0.5s", "#2ecc71");
            playB(combo>=5?1000:600, 0.08);
            if (currentCharIdx >= formulas[currentLevel].length) {
                isPlaying = false; levelTimes[currentLevel] = (Date.now()-startTime)/1000;
                showLevelClear();
            } else updateUI();
        } else {
            combo = 0; timeBonus -= 1.5; msg("-1.5s", "var(--accent)"); playB(150, 0.2);
            if (currentDiff >= 19.62) { currentCharIdx = 0; updateUI(); }
        }
    }

    function msg(t, c) {
        const d = document.createElement('div'); d.className = 'float-msg'; d.innerText = t; d.style.color = c;
        d.style.left = player.x + 'px'; d.style.top = player.y - 40 + 'px';
        document.getElementById('msgContainer').appendChild(d);
        setTimeout(() => d.remove(), 1000);
    }

    function updateUI() {
        const f = formulas[currentLevel];
        let h = "";
        f.forEach((c, i) => {
            if (i < currentCharIdx) h += `<span style="color:#2ecc71">${c}</span>`;
            else if (i === currentCharIdx) h += `<span class="next-char">${c}</span>`;
            else h += `<span style="opacity:0.2">${c}</span>`;
        });
        document.getElementById('targetEquation').innerHTML = h;
    }

    function showLevelClear() {
        const ov = document.getElementById('levelClearOverlay'); // å€Ÿç”¨æš«åœæˆ–çµç®—é‚è¼¯
        playB(800, 0.1); playB(1000, 0.2); // ç°¡å–®å‹åˆ©éŸ³
        if (currentLevel < 3) {
            const btn = document.createElement('button'); btn.className = 'btn-main'; btn.innerText = 'ä¸‹ä¸€é—œ';
            btn.onclick = () => { this.remove(); startLevel(currentLevel + 1); };
            // é€™è£¡ç‚ºäº†ç°¡åŒ– codeï¼Œç›´æ¥é¡¯ç¤º alert å¾Œä¸‹ä¸€é—œ
            alert(`é—œå¡ ${currentLevel+1} å®Œæˆï¼è€—æ™‚: ${levelTimes[currentLevel].toFixed(2)}s`);
            startLevel(currentLevel + 1);
        } else showFinal();
    }

    async function showFinal() {
        const ov = document.getElementById('resultOverlay'); ov.classList.remove('hidden');
        let total = 0; const tbl = document.getElementById('statsTable'); tbl.innerHTML = "";
        levelTimes.forEach((t, i) => { total += t; tbl.innerHTML += `<tr><td>é—œå¡ ${i+1}</td><td>${t.toFixed(2)}s</td></tr>`; });
        document.getElementById('totalScoreText').innerText = `ç¸½æˆç¸¾ï¼š${total.toFixed(2)}s`;
        
        // å‹åˆ©å¤§åˆå¥
        [600, 800, 1000, 1200].forEach((f, i) => setTimeout(() => playB(f, 0.2), i*150));

        const name = document.getElementById('playerName').value || "ANONYMOUS";
        const gameUrl = window.location.href;
        document.getElementById('qrcode').src = `https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=${encodeURIComponent(gameUrl)}`;
        document.getElementById('waShare').onclick = () => {
            const txt = `ğŸ æˆ‘åœ¨ã€Œè˜‹æœçš„è€ƒé©—ã€ä¸­æ‹¿åˆ° ${total.toFixed(2)}s æˆç¸¾ï¼æŒ‘æˆ°é€£çµï¼š${gameUrl}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`);
        };
        addDoc(collection(db, "physics_leaderboard"), { name, totalTime: total.toFixed(2), compositeScore: 1000000-Math.floor(total*100) });
    }

    window.exitToHome = () => {
        document.getElementById('resultOverlay').classList.add('hidden');
        document.getElementById('quoteOverlay').classList.remove('hidden');
        setTimeout(() => location.reload(), 4000);
    };
</script>
</body>
</html>
