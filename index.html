<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>è˜‹æœçš„è€ƒé©— v0.9.0</title>
<style>
    body { margin: 0; padding: 0; background-color: #2c3e50; display: flex; justify-content: center; align-items: center; height: 100vh; height: 100dvh; font-family: 'Segoe UI', Arial, sans-serif; overflow: hidden; color: white; }
    #gameContainer { position: relative; width: 100vw; height: 100vh; background-color: #34495e; overflow: hidden; }
    canvas { display: block; width: 100%; height: 100%; touch-action: none; }
    #ui { position: absolute; top: 10px; left: 15px; right: 15px; display: flex; justify-content: space-between; font-size: 18px; font-weight: bold; pointer-events: none; z-index: 5; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); }
    #equationHeader { position: absolute; top: 45px; left: 0; right: 0; text-align: center; z-index: 5; pointer-events: none; padding: 10px; }
    #targetEquation { font-size: clamp(16px, 5.5vw, 32px); font-weight: bold; color: #f1c40f; background: rgba(0,0,0,0.7); padding: 12px; border-radius: 12px; display: inline-block; letter-spacing: 2px; min-width: 88%; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
    .next-char { color: #ffffff; text-decoration: underline; text-underline-offset: 6px; animation: blink 0.8s infinite; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    #powerUpMsg { position: absolute; top: 160px; left: 50%; transform: translateX(-50%); font-size: 22px; font-weight: bold; color: #2ecc71; text-shadow: 0 0 10px #27ae60; opacity: 0; transition: opacity 0.3s; z-index: 5; }
    #controls { position: absolute; bottom: 25px; left: 0; right: 0; display: flex; justify-content: center; gap: 8px; padding: 0 5px; z-index: 10; pointer-events: none; }
    .control-btn { width: 68px; height: 68px; border-radius: 15px; background: rgba(0, 0, 0, 0.6); color: white; font-size: 24px; display: flex; justify-content: center; align-items: center; pointer-events: auto; cursor: pointer; border: 2px solid rgba(255,255,255,0.3); }
    
    /* å½ˆå‡ºå±¤æ¨£å¼ */
    .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; z-index: 20; padding: 20px; box-sizing: border-box; }
    #rulesBox { background: rgba(241, 196, 15, 0.1); border: 1px solid #f1c40f; border-radius: 10px; padding: 12px; margin: 10px 0; width: 92%; max-width: 420px; font-size: 13px; text-align: left; }
    .start-btn { padding: 12px 45px; font-size: 22px; cursor: pointer; border: none; border-radius: 50px; background-color: #e74c3c; color: white; font-weight: bold; margin-top: 10px; }
    .hidden { display: none !important; }
</style>
</head>
<body>

<div id="gameContainer">
    <div id="ui">
        <div id="levelDisplay">é—œå¡: 1/4</div>
        <div id="timeDisplay">å‰©é¤˜: 9.81s</div>
        <div style="font-size: 12px; opacity: 0.6;">v0.9.0</div>
    </div>
    <div id="equationHeader"><div id="targetEquation">æº–å‚™æŒ‘æˆ°...</div></div>
    <div id="powerUpMsg">â° +3s</div>
    <canvas id="gameCanvas"></canvas>
    
    <div id="controls">
        <div class="control-btn" id="btnFastLeft">â—€â—€</div>
        <div class="control-btn" id="btnLeft">â—€</div>
        <div class="control-btn" id="btnRight">â–¶</div>
        <div class="control-btn" id="btnFastRight">â–¶â–¶</div>
    </div>

    <div id="startOverlay" class="overlay">
        <h1 style="color: #e74c3c; margin: 5px 0; font-size: 30px;">ğŸ è˜‹æœçš„è€ƒé©—</h1>
        <div id="rulesBox">
            <h3 style="margin: 0 0 5px 0; color: #f1c40f; text-align: center;">ğŸ“œ åˆ†é—œæ¨¡å¼èªªæ˜</h3>
            1. éŠæˆ²åˆ† 4 é—œï¼Œæ¯é—œå®Œæˆä¸€æ¢ç‰©ç†å…¬å¼ã€‚<br>
            2. æ¯ä¸€é—œé–‹å§‹æ™‚ï¼Œè¨ˆæ™‚å™¨å°‡é‡è¨­ç‚º <b>9.81 ç§’</b>ã€‚<br>
            3. æ¥ä¸­<b>â° æ™‚é˜</b>åŠ  3 ç§’ï¼›æ¥ä¸­æ­£ç¢ºå­—å…ƒåŠ  0.5 ç§’ã€‚<br>
            4. <b>é›»è…¦æ“ä½œ</b>ï¼šâ† / â†’ å¾®èª¿ï¼ŒæŒ‰ä½ <b>Shift</b> å¿«é€Ÿè¡åˆºã€‚
        </div>
        <input type="text" id="playerName" maxlength="10" placeholder="è¼¸å…¥å­¸éœ¸åå­—" style="font-size: 18px; padding: 10px; border-radius: 8px; border: none; margin-bottom: 10px;">
        <button class="start-btn" onclick="initGame()">é–‹å§‹æŒ‘æˆ°</button>
    </div>

    <div id="levelOverlay" class="overlay hidden">
        <h2 id="levelStatus" style="color: #f1c40f;">Level Clear!</h2>
        <p id="levelStats">æœ¬é—œè€—æ™‚: 5.0s</p>
        <button id="nextLevelBtn" class="start-btn">é€²å…¥ä¸‹ä¸€é—œ</button>
    </div>

    <div id="finalOverlay" class="overlay hidden">
        <h1 style="color: #e74c3c;">ğŸ† æŒ‘æˆ°å®Œæˆ</h1>
        <p id="finalStats">ç¸½æˆç¸¾å·²ä¸Šå‚³è‡³æ¦œå–®</p>
        <div id="leaderboard" style="width: 100%; margin: 15px 0; font-size: 14px;">
            <ol id="scoreList" style="text-align: left; display: inline-block;"><li>è¼‰å…¥æ¦œä¸­...</li></ol>
        </div>
        <button class="start-btn" onclick="location.reload()">é‡æ–°é–‹å§‹</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDoHHh-8Gm5tt_uWF4IPGIGfOTNYnAgHr4",
      authDomain: "physicsgame-rl.firebaseapp.com",
      projectId: "physicsgame-rl",
      storageBucket: "physicsgame-rl.firebasestorage.app",
      messagingSenderId: "68402923149",
      appId: "1:68402923149:web:0bb2be531b9e971a6544c4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const targetEqDisplay = document.getElementById('targetEquation');
    const timeDisplay = document.getElementById('timeDisplay');
    const levelDisplay = document.getElementById('levelDisplay');
    const powerUpMsg = document.getElementById('powerUpMsg');
    
    const formulas = [
        ['v', '=', 'u', '+', 'a', 't'],
        ['s', '=', 'Â½', '(', 'u', '+', 'v', ')', 't'],
        ['s', '=', 'u', 't', '+', 'Â½', 'a', 't', 'Â²'],
        ['v', 'Â²', '=', 'u', 'Â²', '+', '2', 'a', 's']
    ];
    const distractorsMap = { 'v': ['u', 'y'], 'u': ['v', 'w'], 's': ['d', 'h'], 'a': ['g', 'q'], 't': ['f', 'x'], '=': ['â‰ˆ', '-'], '+': ['-', 'Ã—'], '(': ['{', '['], ')': ['}', ']'], 'Â²': ['Â³', '2'], 'Â½': ['â…“', 'Â¼'], '2': ['3', 'z'] };

    let isPlaying = false, startTime, totalBonusTime = 0, currentLevel = 0, currentCharIdx = 0, objects = [], player = { x: 0, y: 0, size: 65 };
    let finalTotalTime = 0;
    const controlState = { left: false, right: false, fastLeft: false, fastRight: false };

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; player.x = canvas.width / 2; player.y = canvas.height - 90; }
    window.addEventListener('resize', resize); resize();

    // æ§åˆ¶ç¶å®š
    const setControl = (key, val) => (e) => { e.preventDefault(); controlState[key] = val; };
    document.getElementById('btnFastLeft').addEventListener('touchstart', setControl('fastLeft', true), {passive:false});
    document.getElementById('btnFastLeft').addEventListener('touchend', setControl('fastLeft', false));
    document.getElementById('btnLeft').addEventListener('touchstart', setControl('left', true), {passive:false});
    document.getElementById('btnLeft').addEventListener('touchend', setControl('left', false));
    document.getElementById('btnRight').addEventListener('touchstart', setControl('right', true), {passive:false});
    document.getElementById('btnRight').addEventListener('touchend', setControl('right', false));
    document.getElementById('btnFastRight').addEventListener('touchstart', setControl('fastRight', true), {passive:false});
    document.getElementById('btnFastRight').addEventListener('touchend', setControl('fastRight', false));

    window.addEventListener('keydown', e => {
        if(e.key === 'ArrowLeft') { if(e.shiftKey) controlState.fastLeft = true; else controlState.left = true; }
        if(e.key === 'ArrowRight') { if(e.shiftKey) controlState.fastRight = true; else controlState.right = true; }
    });
    window.addEventListener('keyup', e => { if(e.key === 'ArrowLeft' || e.key === 'Shift') { controlState.left = false; controlState.fastLeft = false; } if(e.key === 'ArrowRight' || e.key === 'Shift') { controlState.right = false; controlState.fastRight = false; } });

    window.initGame = () => {
        document.getElementById('startOverlay').classList.add('hidden');
        startLevel(0);
    };

    function startLevel(idx) {
        currentLevel = idx;
        currentCharIdx = 0;
        totalBonusTime = 0;
        objects = [];
        isPlaying = true;
        startTime = Date.now();
        levelDisplay.innerText = `é—œå¡: ${currentLevel + 1}/4`;
        updateFormulaDisplay();
        requestAnimationFrame(gameLoop);
    }

    function updateFormulaDisplay() {
        const currentF = formulas[currentLevel];
        let html = "";
        for (let i = 0; i < currentF.length; i++) {
            if (i < currentCharIdx) html += `<span style="color:#2ecc71">${currentF[i]}</span>`;
            else if (i === currentCharIdx) html += `<span class="next-char">${currentF[i]}</span>`;
            else html += `<span style="opacity:0.2">${currentF[i]}</span>`;
        }
        targetEqDisplay.innerHTML = html;
    }

    function spawnObject() {
        const currentF = formulas[currentLevel];
        const targetChar = currentF[currentCharIdx];
        const rand = Math.random();
        let char = '', type = 'distractor';

        if (rand < 0.05) { char = 'â°'; type = 'clock'; }
        else if (rand < 0.65) {
            const nextIdx = currentCharIdx + 1;
            if (nextIdx < currentF.length && Math.random() > 0.6) { char = currentF[nextIdx]; type = 'future'; }
            else { char = targetChar; type = 'correct'; }
        } else {
            const sim = distractorsMap[targetChar] || ['X', 'Y'];
            char = sim[Math.floor(Math.random() * sim.length)];
        }
        objects.push({ char, type, x: Math.random()*(canvas.width-40)+20, y: -50, size: 45, speed: (canvas.height * 0.004) * (0.9 + Math.random() * 0.3) });
    }

    function gameLoop() {
        if (!isPlaying) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        let now = Date.now();
        let displayTime = Math.max(0, 9.81 + totalBonusTime - (now - startTime)/1000);
        timeDisplay.innerText = `å‰©é¤˜: ${displayTime.toFixed(2)}s`;
        
        if (displayTime <= 0) { isPlaying = false; alert("æ™‚é–“åˆ°ï¼è©²é—œå¤±æ•—ã€‚"); location.reload(); return; }

        if (controlState.fastLeft) player.x -= canvas.width * 0.035; else if (controlState.left) player.x -= canvas.width * 0.012;
        if (controlState.fastRight) player.x += canvas.width * 0.035; else if (controlState.right) player.x += canvas.width * 0.012;
        player.x = Math.max(player.size/2, Math.min(canvas.width - player.size/2, player.x));

        ctx.font = `${player.size}px Arial`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.fillText('ğŸ', player.x, player.y);

        const currentF = formulas[currentLevel];
        for (let i = objects.length - 1; i >= 0; i--) {
            const o = objects[i]; o.y += o.speed;
            if (o.y > canvas.height + 50) { objects.splice(i, 1); continue; }

            ctx.font = `bold ${o.size}px Arial`;
            ctx.fillStyle = (o.char === currentF[currentCharIdx]) ? '#f1c40f' : 'white';
            ctx.fillText(o.char, o.x, o.y);

            if (Math.abs(player.x - o.x) < 40 && Math.abs(player.y - o.y) < 40) {
                handleCatch(o);
                objects.splice(i, 1);
                continue;
            }
        }
        if (Math.random() < 0.05) spawnObject();
        requestAnimationFrame(gameLoop);
    }

    function handleCatch(obj) {
        if (obj.type === 'clock') { totalBonusTime += 3; showMsg("â° +3s"); return; }
        
        const currentF = formulas[currentLevel];
        if (obj.char === currentF[currentCharIdx]) {
            currentCharIdx++;
            totalBonusTime += 0.5; // æ¥ä¸­æ­£ç¢ºåŠ  0.5s
            if (currentCharIdx >= currentF.length) {
                isPlaying = false;
                const timeTaken = (Date.now() - startTime) / 1000;
                finalTotalTime += timeTaken;
                showLevelClear(timeTaken);
            } else {
                updateFormulaDisplay();
            }
        } else {
            totalBonusTime -= 1.5; // æ¥éŒ¯æ‰£ 1.5s
            showMsg("âŒ -1.5s");
        }
    }

    function showLevelClear(time) {
        document.getElementById('levelOverlay').classList.remove('hidden');
        document.getElementById('levelStatus').innerText = (currentLevel === 3) ? "ğŸ‰ æ­å–œå®Œæˆæ‰€æœ‰é—œå¡ï¼" : `Level ${currentLevel + 1} Clear!`;
        document.getElementById('levelStats').innerText = `æœ¬é—œè€—æ™‚: ${time.toFixed(2)}s`;
        
        const nextBtn = document.getElementById('nextLevelBtn');
        if (currentLevel < 3) {
            nextBtn.innerText = "é€²å…¥ä¸‹ä¸€é—œ";
            nextBtn.onclick = () => {
                document.getElementById('levelOverlay').classList.add('hidden');
                startLevel(currentLevel + 1);
            };
        } else {
            nextBtn.innerText = "æŸ¥çœ‹ç¸½æˆç¸¾";
            nextBtn.onclick = showFinalResult;
        }
    }

    async function showFinalResult() {
        document.getElementById('levelOverlay').classList.add('hidden');
        document.getElementById('finalOverlay').classList.remove('hidden');
        document.getElementById('finalStats').innerText = `ç¸½æŒ‘æˆ°è€—æ™‚: ${finalTotalTime.toFixed(2)}s`;
        
        const pName = document.getElementById('playerName').value.trim().toUpperCase() || "ANON";
        try {
            const compositeScore = 400000 + (100000 - Math.floor(finalTotalTime * 100));
            await addDoc(collection(db, "physics_leaderboard"), { name: pName, completed: 4, timeUsed: finalTotalTime.toFixed(2), compositeScore, timestamp: new Date() });
            renderLeaderboard();
        } catch (e) {}
    }

    async function renderLeaderboard() {
        try {
            const q = query(collection(db, "physics_leaderboard"), orderBy("compositeScore", "desc"), limit(5));
            const snap = await getDocs(q);
            const list = document.getElementById('scoreList'); list.innerHTML = '';
            snap.forEach(doc => { const d = doc.data(); list.innerHTML += `<li><b>${d.name}</b>: ${d.timeUsed}s</li>`; });
        } catch (e) {}
    }

    function showMsg(txt) { powerUpMsg.innerText = txt; powerUpMsg.style.opacity = 1; setTimeout(() => { powerUpMsg.style.opacity = 0; }, 1000); }
</script>
</body>
</html>
