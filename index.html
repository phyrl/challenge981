<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ç‰›é “çš„è€ƒé©— - ä¿®æ­£ç‰ˆ</title>
<style>
    body { margin: 0; padding: 0; background-color: #2c3e50; display: flex; justify-content: center; align-items: center; height: 100vh; height: 100dvh; font-family: 'Segoe UI', Arial, sans-serif; overflow: hidden; color: white; }
    #gameContainer { position: relative; width: 100vw; height: 100vh; background-color: #34495e; overflow: hidden; }
    canvas { display: block; width: 100%; height: 100%; touch-action: none; }
    #ui { position: absolute; top: 10px; left: 15px; right: 15px; display: flex; justify-content: space-between; font-size: 20px; font-weight: bold; pointer-events: none; z-index: 5; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); }
    #equationHeader { position: absolute; top: 50px; left: 0; right: 0; text-align: center; z-index: 5; pointer-events: none; padding: 10px; }
    #targetEquation { font-size: clamp(20px, 6vw, 42px); font-weight: bold; color: #f1c40f; background: rgba(0,0,0,0.6); padding: 15px; border-radius: 15px; display: inline-block; letter-spacing: 3px; min-width: 80%; box-shadow: 0 4px 15px rgba(0,0,0,0.3); line-height: 1.5; }
    .next-char { color: #ffffff; text-decoration: underline; text-underline-offset: 8px; animation: blink 0.8s infinite; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    #powerUpMsg { position: absolute; top: 160px; left: 50%; transform: translateX(-50%); font-size: 24px; font-weight: bold; color: #2ecc71; text-shadow: 0 0 10px #27ae60; opacity: 0; transition: opacity 0.3s; z-index: 5; }
    #controls { position: absolute; bottom: 30px; left: 0; right: 0; display: flex; justify-content: space-between; padding: 0 10vw; z-index: 10; pointer-events: none; }
    .control-btn { width: 80px; height: 80px; border-radius: 50%; background: rgba(0, 0, 0, 0.5); color: white; font-size: 36px; display: flex; justify-content: center; align-items: center; pointer-events: auto; cursor: pointer; user-select: none; border: 2px solid rgba(255,255,255,0.3); }
    #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; z-index: 20; padding: 20px; box-sizing: border-box; }
    #playerName { font-size: 20px; padding: 12px; border-radius: 8px; border: none; width: 80%; max-width: 250px; margin: 15px 0; text-align: center; text-transform: uppercase; }
    #difficultyUI { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 15px 0; }
    .diff-label { background: #444; padding: 10px 15px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: 0.3s; font-size: 14px; }
    input[type="radio"]:checked + .diff-label { border-color: #e74c3c; background: #c0392b; }
    button.start { padding: 15px 50px; font-size: 24px; cursor: pointer; border: none; border-radius: 50px; background-color: #e74c3c; color: white; font-weight: bold; margin-top: 20px; }
    #leaderboard { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; width: 90%; max-width: 400px; margin: 15px 0; font-size: 14px; text-align: left; }
    .hidden { display: none !important; }
</style>
</head>
<body>

<div id="gameContainer">
    <div id="ui">
        <div id="timeDisplay">æ™‚é–“: 33.00s</div>
        <div id="scoreDisplay">é€²åº¦: 0/4</div>
    </div>
    <div id="equationHeader">
        <div style="font-size:16px; color:#bdc3c7; margin-bottom:5px;">æ­£åœ¨æ‹¼æ¹Šå…¬å¼...</div>
        <div id="targetEquation">è¼‰å…¥ä¸­...</div>
    </div>
    <div id="powerUpMsg">â­â­ å…¬å¼è­·ç›¾ â­â­</div>
    <canvas id="gameCanvas"></canvas>
    <div id="controls">
        <div class="control-btn" id="btnLeft">â—€</div>
        <div class="control-btn" id="btnRight">â–¶</div>
    </div>
    <div id="overlay">
        <h1 style="color: #e74c3c; margin: 0;">ğŸ ç‰›é “çš„è€ƒé©—</h1>
        <p style="color: #f1c40f;">é †åºå¡«å……èƒŒèª¦ç‰ˆ</p>
        <div id="finalScore" class="hidden" style="font-size: 18px; margin: 10px;"></div>
        <input type="text" id="playerName" maxlength="10" placeholder="ä½ çš„åå­—">
        <div id="difficultyUI">
            <input type="radio" name="diff" value="0" id="d0" checked class="hidden"><label for="d0" class="diff-label">é›£åº¦ 0</label>
            <input type="radio" name="diff" value="9.81" id="d1" class="hidden"><label for="d1" class="diff-label">é›£åº¦ 9.81</label>
            <input type="radio" name="diff" value="19.62" id="d2" class="hidden"><label for="d2" class="diff-label">é›£åº¦ 19.62</label>
            <input type="radio" name="diff" value="39.24" id="d3" class="hidden"><label for="d3" class="diff-label">é›£åº¦ 39.24</label>
        </div>
        <div id="leaderboard">
            <h3 style="text-align:center; margin-top:0;">å­¸éœ¸æ¦œ (Top 5)</h3>
            <ol id="scoreList"><li>è¼‰å…¥ä¸­...</li></ol>
        </div>
        <button class="start" id="startBtn">é–‹å§‹æŒ‘æˆ° (33ç§’)</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    // ğŸ”´ ğŸ”´ è«‹æ›´æ›ç‚ºä½ çš„ Firebase Config ğŸ”´ ğŸ”´
    const firebaseConfig = {
      apiKey: "AIzaSyDoHHh-8Gm5tt_uWF4IPGIGfOTNYnAgHr4",
      authDomain: "physicsgame-rl.firebaseapp.com",
      projectId: "physicsgame-rl",
      storageBucket: "physicsgame-rl.firebasestorage.app",
      messagingSenderId: "68402923149",
      appId: "1:68402923149:web:0bb2be531b9e971a6544c4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const targetEqDisplay = document.getElementById('targetEquation');
    const timeDisplay = document.getElementById('timeDisplay');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const powerUpMsg = document.getElementById('powerUpMsg');
    const overlay = document.getElementById('overlay');
    const startBtn = document.getElementById('startBtn');
    const playerNameInput = document.getElementById('playerName');

    const formulas = [
        ['v', '=', 'u', '+', 'a', 't'],
        ['s', '=', 'Â½', '(', 'u', '+', 'v', ')', 't'],
        ['s', '=', 'u', 't', '+', 'Â½', 'a', 't', 'Â²'],
        ['v', 'Â²', '=', 'u', 'Â²', '+', '2', 'a', 's']
    ];

    const distractorsMap = {
        'v': ['u', 'y'], 'u': ['v', 'w'], 's': ['d', 'h'], 'a': ['g', 'q'], 't': ['f', 'x'],
        '=': ['â‰ˆ', '-'], '+': ['-', 'Ã—'], '(': ['{', '['], ')': ['}', ']'],
        'Â²': ['Â³', '2'], 'Â½': ['â…“', 'Â¼'], '2': ['3', 'z']
    };

    let isPlaying = false, startTime, totalBonusTime = 0, currentDisplayTime = 33.00;
    let currentFormulaIdx = 0, currentCharIdx = 0;
    let animationId, currentDiff = 0, isInvincible = false, invincibleTimer = null;
    let player = { x: 0, y: 0, size: 0 }, objects = [];
    const keys = { ArrowLeft: false, ArrowRight: false };

    const diffSettings = {
        '0':     { trapRatio: 1, penalty: 1, reset: false, star: false, speed: 0.0035 },
        '9.81':  { trapRatio: 3, penalty: 2, reset: false, star: false, speed: 0.0055 },
        '19.62': { trapRatio: 5, penalty: 0, reset: true,  star: true,  speed: 0.0075 },
        '39.24': { trapRatio: 10, penalty: 0, reset: true,  star: true,  speed: 0.0100 }
    };

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        player.size = Math.min(canvas.width * 0.12, 70);
        player.x = canvas.width / 2;
        player.y = canvas.height - player.size - 20;
    }
    window.addEventListener('resize', resize);
    resize();

    window.addEventListener('keydown', e => { if(e.key==='ArrowLeft') keys.ArrowLeft=true; if(e.key==='ArrowRight') keys.ArrowRight=true; });
    window.addEventListener('keyup', e => { if(e.key==='ArrowLeft') keys.ArrowLeft=false; if(e.key==='ArrowRight') keys.ArrowRight=false; });
    
    const bLeft = document.getElementById('btnLeft');
    const bRight = document.getElementById('btnRight');
    const handleTouch = (key, state) => (e) => { e.preventDefault(); keys[key] = state; };
    bLeft.addEventListener('touchstart', handleTouch('ArrowLeft', true), {passive:false});
    bLeft.addEventListener('touchend', handleTouch('ArrowLeft', false));
    bRight.addEventListener('touchstart', handleTouch('ArrowRight', true), {passive:false});
    bRight.addEventListener('touchend', handleTouch('ArrowRight', false));

    function updateFormulaDisplay() {
        if (currentFormulaIdx >= formulas.length) return;
        const currentF = formulas[currentFormulaIdx];
        let html = "";
        for (let i = 0; i < currentF.length; i++) {
            if (i < currentCharIdx) html += `<span style="color:#2ecc71">${currentF[i]}</span>`;
            else if (i === currentCharIdx) html += `<span class="next-char">${currentF[i]}</span>`;
            else html += `<span style="opacity:0.2">${currentF[i]}</span>`;
        }
        targetEqDisplay.innerHTML = html;
        scoreDisplay.innerText = `é€²åº¦: ${currentFormulaIdx}/4`;
    }

    function spawnObject() {
        if (!isPlaying || currentFormulaIdx >= formulas.length) return;
        const config = diffSettings[currentDiff];
        const targetChar = formulas[currentFormulaIdx][currentCharIdx];
        const rand = Math.random();
        let char = '', type = 'distractor';
        
        if (rand < 0.02) { char = 'â°'; type = 'clock'; }
        else if (rand < 0.04 && config.star) { char = 'â­'; type = 'star'; }
        else if (rand < 0.35) { char = targetChar; type = 'correct'; }
        else {
            const sim = distractorsMap[targetChar] || ['X', 'Y', 'Z'];
            char = sim[Math.floor(Math.random() * sim.length)];
        }

        const size = Math.min(canvas.width * 0.08, 45);
        let x = (type === 'correct') ? 
                player.x - (canvas.width * 0.2) + Math.random() * (canvas.width * 0.4) :
                Math.random() * (canvas.width - size);
        x = Math.max(size, Math.min(canvas.width - size, x));

        objects.push({ char, type, x, y: -size, size, speed: canvas.height * config.speed * (0.9 + Math.random() * 0.2) });
    }

    function gameLoop() {
        if (!isPlaying) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        let elapsed = (Date.now() - startTime) / 1000;
        currentDisplayTime = Math.max(0, 33.00 + totalBonusTime - elapsed);
        timeDisplay.innerText = `æ™‚é–“: ${currentDisplayTime.toFixed(2)}s`;
        if (currentDisplayTime <= 0) { endGame(false); return; }

        const pSpeed = canvas.width * 0.018;
        if (keys.ArrowLeft && player.x > player.size/2) player.x -= pSpeed;
        if (keys.ArrowRight && player.x < canvas.width - player.size/2) player.x += pSpeed;

        ctx.font = `${player.size}px Arial`;
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        if (isInvincible) { ctx.shadowColor = "#f1c40f"; ctx.shadowBlur = 20; }
        ctx.fillText('ğŸ', player.x, player.y);
        ctx.shadowBlur = 0;

        for (let i = objects.length - 1; i >= 0; i--) {
            const o = objects[i];
            o.y += o.speed;
            ctx.font = `bold ${o.size}px Arial`;
            ctx.fillStyle = (o.type === 'correct' && currentDiff == 0) ? '#f1c40f' : 'white';
            ctx.fillText(o.char, o.x, o.y);

            if (Math.hypot(player.x - o.x, player.y - o.y) < (player.size + o.size) * 0.45) {
                handleCatch(o);
                objects.splice(i, 1);
                continue;
            }
            if (o.y > canvas.height + 50) objects.splice(i, 1);
        }

        if (Math.random() < 0.04) spawnObject();
        animationId = requestAnimationFrame(gameLoop);
    }

    function handleCatch(obj) {
        if (!isPlaying) return;
        const config = diffSettings[currentDiff];
        
        if (obj.type === 'clock') {
            totalBonusTime += 5;
            showMsg("â° æ™‚é–“ +5 ç§’");
        } else if (obj.type === 'star') {
            activateStar();
        } else if (obj.type === 'correct') {
            currentCharIdx++;
            if (currentCharIdx >= formulas[currentFormulaIdx].length) {
                currentFormulaIdx++;
                currentCharIdx = 0;
                totalBonusTime += 5;
                objects = []; // é—œéµä¿®æ­£ï¼šå…¬å¼åˆ‡æ›æ™‚æ¸…å ´
                showMsg("âœ… å®Œæˆå…¬å¼ï¼åŠ æ™‚ 5s");
                if (currentFormulaIdx >= formulas.length) {
                    endGame(true);
                    return;
                }
            }
            updateFormulaDisplay();
        } else {
            if (isInvincible) { showMsg("ğŸ›¡ï¸ å·²é˜»æ“‹"); return; }
            if (config.reset) {
                currentCharIdx = 0;
                showMsg("âŒ éŒ¯èª¤ï¼å…¬å¼é‡ç½®");
            } else {
                totalBonusTime -= config.penalty;
                showMsg(`âŒ éŒ¯èª¤ï¼æ‰£ ${config.penalty} ç§’`);
            }
            updateFormulaDisplay();
        }
    }

    function activateStar() {
        isInvincible = true; showMsg("â­ ç²å¾—è­·ç›¾ â­");
        if (invincibleTimer) clearTimeout(invincibleTimer);
        invincibleTimer = setTimeout(() => { isInvincible = false; }, 5000);
    }

    function showMsg(txt) {
        powerUpMsg.innerText = txt; powerUpMsg.style.opacity = 1;
        setTimeout(() => { if (powerUpMsg.innerText === txt) powerUpMsg.style.opacity = 0; }, 1500);
    }

    async function endGame(win) {
        isPlaying = false;
        cancelAnimationFrame(animationId);
        const timeUsed = (33.00 + totalBonusTime - currentDisplayTime).toFixed(2);
        const pName = playerNameInput.value.trim().toUpperCase() || "ANONYMOUS";
        
        document.getElementById('finalScore').innerText = win ? `ğŸ‰ æŒ‘æˆ°æˆåŠŸï¼è€—æ™‚ï¼š${timeUsed}s` : `æ™‚é–“åˆ°ï¼å®Œæˆäº† ${currentFormulaIdx} æ¢å…¬å¼`;
        document.getElementById('finalScore').classList.remove('hidden');
        overlay.classList.remove('hidden');

        if (win) {
            try {
                const compositeScore = 400000 + (100000 - Math.floor(parseFloat(timeUsed)*100));
                await addDoc(collection(db, "physics_leaderboard"), {
                    name: pName, completed: 4, timeUsed: timeUsed, difficulty: currentDiff, compositeScore, timestamp: new Date()
                });
                renderLeaderboard();
            } catch (e) { console.error(e); }
        }
    }

    async function renderLeaderboard() {
        try {
            const q = query(collection(db, "physics_leaderboard"), orderBy("compositeScore", "desc"), limit(5));
            const snap = await getDocs(q);
            const list = document.getElementById('scoreList');
            list.innerHTML = '';
            if (snap.empty) list.innerHTML = '<li>æœªæœ‰ç´€éŒ„</li>';
            snap.forEach(doc => {
                const d = doc.data();
                list.innerHTML += `<li><b>${d.name}</b> - ${d.timeUsed}s (é›£åº¦ ${d.difficulty})</li>`;
            });
        } catch (e) { document.getElementById('scoreList').innerHTML = '<li>è¼‰å…¥å¤±æ•—</li>'; }
    }

    startBtn.onclick = () => {
        currentDiff = document.querySelector('input[name="diff"]:checked').value;
        currentFormulaIdx = 0; currentCharIdx = 0; totalBonusTime = 0;
        objects = []; isPlaying = true; startTime = Date.now();
        overlay.classList.add('hidden');
        updateFormulaDisplay();
        resize();
        gameLoop();
    };

    renderLeaderboard();
</script>
</body>
</html>
