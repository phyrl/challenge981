<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>è˜‹æœçš„è€ƒé©— V0.6.2.4</title>
<style>
    :root { --accent: #e74c3c; --gold: #f1c40f; --bg: #0d0d0d; }
    body { margin: 0; background: var(--bg); color: white; font-family: 'Segoe UI', Arial, sans-serif; overflow: hidden; touch-action: none; }
    #gameContainer { position: relative; width: 100vw; height: 100vh; background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%); }
    canvas { display: block; width: 100%; height: 100%; }

    /* UI é ‚éƒ¨ */
    #ui { position: absolute; top: 12px; left: 15px; right: 15px; display: flex; justify-content: space-between; align-items: center; z-index: 50; pointer-events: none; }
    .ui-item { background: rgba(0,0,0,0.6); padding: 6px 14px; border-radius: 20px; font-weight: bold; border: 1px solid rgba(255,255,255,0.2); font-size: 14px; }
    #pauseBtn { pointer-events: auto; cursor: pointer; background: var(--accent); border: none; color: white; padding: 6px 18px; border-radius: 20px; font-weight: bold; }

    /* å…¬å¼é¡¯ç¤º */
    #equationHeader { position: absolute; top: 60px; left: 0; right: 0; text-align: center; z-index: 40; pointer-events: none; }
    #targetEquation { font-size: clamp(14px, 4.5vw, 28px); font-weight: bold; color: var(--gold); background: rgba(0,0,0,0.8); padding: 12px 20px; border-radius: 15px; display: inline-block; min-width: 85%; border: 1px solid rgba(241, 196, 15, 0.4); }
    .next-char { color: #fff; text-decoration: underline; text-underline-offset: 6px; animation: blink 0.8s infinite; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

    /* Overlay å„ªåŒ–ï¼šç¢ºä¿æ‰‹æ©ŸæŒ‰éˆ•å®Œæ•´ */
    .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; align-items: center; text-align: center; z-index: 100; padding: 15px; box-sizing: border-box; backdrop-filter: blur(8px); overflow-y: auto; justify-content: flex-start; padding-top: 5vh; }
    .hidden { display: none !important; }

    /* é›£åº¦æ£ç½®ä¸­ */
    .diff-container { display: flex; justify-content: center; width: 100%; margin: 10px 0; }
    .diff-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 100%; max-width: 300px; }
    .diff-label { background: #222; padding: 12px; border-radius: 10px; border: 1px solid #444; font-size: 13px; cursor: pointer; display: block; }
    input[type="radio"]:checked + .diff-label { border-color: var(--accent); background: #442222; }

    /* æŒ‰éˆ•æ¨£å¼ */
    .btn-apple { padding: 12px 35px; font-size: 18px; cursor: pointer; border: none; border-radius: 50px; background: var(--accent); color: white; font-weight: bold; margin: 5px; transition: 0.3s; }
    .btn-sub { background: #34495e; font-size: 13px; padding: 8px 18px; }

    /* éå ´å‹•ç•«ï¼šåå³ä¸”é€Ÿåº¦æ¸›æ…¢ */
    .falling-apple-box { position: absolute; top: -100px; left: 75%; transform: translateX(-50%); font-size: 70px; display: none; }
    .falling-apple-box.active { display: block; animation: appleDrop 2.4s linear forwards; }
    @keyframes appleDrop { 0% { top: -100px; } 100% { top: 120%; } }

    #countdownOverlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); font-size: 60px; font-weight: bold; color: var(--accent); z-index: 200; text-shadow: 0 0 20px black; }
    #statsTable { width: 100%; max-width: 280px; border-collapse: collapse; margin-bottom: 10px; font-size: 14px; }
    #statsTable td { padding: 6px; border-bottom: 1px solid rgba(255,255,255,0.1); }
</style>
</head>
<body>

<div id="gameContainer">
    <div id="ui">
        <div class="ui-item" id="levelDisplay">ç¬¬ 1 é—œ</div>
        <div class="ui-item" id="timeDisplay">19.62s</div>
        <button id="pauseBtn" onclick="togglePause()">â¸ æš«åœ</button>
    </div>

    <div id="equationHeader"><div id="targetEquation">æº–å‚™æŒ‘æˆ°...</div></div>
    <div id="countdownOverlay" class="hidden"></div>
    <canvas id="gameCanvas"></canvas>

    <div id="mainMenu" class="overlay">
        <h1 style="color:var(--accent); font-size:36px; margin:0;">ğŸ è˜‹æœçš„è€ƒé©—</h1>
        <p style="color:var(--gold); margin:5px 0; font-size:14px;">ç ”ç¿’ç‰©ç†ï¼Œéœ€å¿ƒç„¡æ—é¶©ã€‚</p>
        
        <input type="text" id="playerName" maxlength="10" placeholder="ä½ çš„åå­— (ANONYMOUS)" style="width:200px; padding:10px; border-radius:10px; border:none; text-align:center; font-size:16px; margin:10px 0; outline:none;">
        
        <div class="diff-container">
            <div class="diff-grid">
                <label><input type="radio" name="diff" value="0" checked style="display:none"><div class="diff-label">é›£åº¦ 0</div></label>
                <label><input type="radio" name="diff" value="9.81" style="display:none"><div class="diff-label">é›£åº¦ 9.81</div></label>
                <label><input type="radio" name="diff" value="19.62" style="display:none"><div class="diff-label">é›£åº¦ 19.62</div></label>
                <label><input type="radio" name="diff" value="29.43" style="display:none"><div class="diff-label">é›£åº¦ 29.43</div></label>
            </div>
        </div>

        <button id="soundBtn" class="btn-apple btn-sub" onclick="toggleSound()">ğŸ”Š è²æ•ˆ: ON</button>
        <button class="btn-apple" onclick="startGame()">é–‹å§‹æŒ‘æˆ°</button>
        <button class="btn-apple btn-sub" onclick="showRules(true)">è¦å‰‡èªªæ˜</button>
    </div>

    <div id="transitionOverlay" class="overlay hidden">
        <div id="transitionApple" class="falling-apple-box">ğŸ</div>
        <h2 style="color:var(--gold); margin-top:80px;" id="transMsg">é—œå¡å®Œæˆï¼</h2>
        <div id="stageSummaryBox" style="background:rgba(255,255,255,0.05); padding:15px; border-radius:15px; margin:10px 0; border:1px solid rgba(241,196,15,0.3);">
            <p id="stageTimeSummary" style="margin:0; font-size:22px; font-weight:bold;"></p>
        </div>
        <button class="btn-apple" id="nextLevelBtn">é€²å…¥ä¸‹ä¸€æ­¥</button>
    </div>

    <div id="rulesOverlay" class="overlay hidden" style="justify-content:center; padding-top:0;">
        <div style="background:rgba(0,0,0,0.85); border:1px solid var(--gold); padding:20px; border-radius:20px; text-align:left; max-width:320px;">
            <h2 style="color:var(--gold); text-align:center; margin-top:0;">ğŸ“œ å¯¦é©—æŒ‡å¼•</h2>
            â€¢ æ¯é—œ 19.62s é–‹å±€ï¼Œæ­£ç¢º +0.5sï¼Œâ° +3sã€‚<br>
            â€¢ â† / â†’ æ…¢é€Ÿå¾®èª¿ï¼›æŒ‰ä½ <b>Shift</b> è¡åˆºã€‚<br>
            â€¢ é›£åº¦ 19.62 ä»¥ä¸Šæ¥éŒ¯å…¬å¼é‡è¨­ã€‚
            <button class="btn-apple btn-sub" onclick="showRules(false)" style="width:100%; margin-top:15px;">è¿”å›ä¸»é </button>
        </div>
    </div>

    <div id="resultOverlay" class="overlay hidden">
        <h1 style="color:var(--gold); margin:0; font-size:28px;">ğŸ† å¯¦é©—æˆåŠŸ</h1>
        <table id="statsTable"></table>
        <h2 id="totalScoreText" style="color:var(--accent); margin:10px 0;"></h2>
        
        <div style="margin-top: 10px;">
            <p style="font-size: 12px; margin-bottom: 5px; opacity: 0.8;">ğŸ“¸ æƒæ QR Code åˆ†äº«ç¶²å€</p>
            <div style="background:white; padding:5px; border-radius:5px; display:inline-block;">
                <img id="qrcode" src="" alt="QR" width="90">
            </div>
        </div>
        
        <button class="btn-apple btn-sub" id="waShare" style="margin-top:15px;">WhatsApp åˆ†äº«æˆ°ç¸¾</button>
        <button class="btn-apple" onclick="exitToHome()">è¿”å›ä¸»é </button>
    </div>

    <div id="quoteOverlay" class="overlay hidden" style="justify-content:center; padding-top:0;">
        <div style="font-size:20px; color:var(--gold); letter-spacing:4px; line-height:2.2;">
            ã€Œç ”ç¿’ç‰©ç†ï¼Œéœ€å¿ƒç„¡æ—é¶©ã€‚ã€<br>ã€Œå¬‰æˆ²ä¹‹æ™‚ï¼Œè«å¿˜æ¢ç´¢çœŸç†ã€‚ã€
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDoHHh-8Gm5tt_uWF4IPGIGfOTNYnAgHr4",
      authDomain: "physicsgame-rl.firebaseapp.com",
      projectId: "physicsgame-rl",
      storageBucket: "physicsgame-rl.firebasestorage.app",
      messagingSenderId: "68402923149",
      appId: "1:68402923149:web:0bb2be531b9e971a6544c4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const formulas = [['v', '=', 'u', '+', 'a', 't'], ['s', '=', 'Â½', '(', 'u', '+', 'v', ')', 't'], ['s', '=', 'u', 't', '+', 'Â½', 'a', 't', 'Â²'], ['v', 'Â²', '=', 'u', 'Â²', '+', '2', 'a', 's']];
    
    let isPlaying = false, isPaused = false, currentLevel = 0, currentCharIdx = 0, startTime, timeBonus = 0, levelTimes = [0,0,0,0], objects = [], soundOn = true, audioCtx = null, currentDiff = 0, lastRemain = 19.62;
    const keys = { left: false, right: false, shift: false };
    const player = { x: 0, y: 0, size: 60 };

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; player.x = canvas.width/2; player.y = canvas.height - 110; }
    window.addEventListener('resize', resize); resize();

    function playB(f, d) {
        if (!soundOn || !audioCtx) return;
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.frequency.setValueAtTime(f, audioCtx.currentTime);
        g.gain.setValueAtTime(0.05, audioCtx.currentTime);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + d);
    }

    window.toggleSound = () => { soundOn = !soundOn; document.getElementById('soundBtn').innerText = soundOn ? "ğŸ”Š è²æ•ˆ: ON" : "ğŸ”‡ è²æ•ˆ: OFF"; };
    window.showRules = (s) => document.getElementById('rulesOverlay').classList.toggle('hidden', !s);
    window.togglePause = () => { if (!isPlaying) return; isPaused = !isPaused; document.getElementById('pauseBtn').innerText = isPaused ? "â–¶ ç¹¼çºŒ" : "â¸ æš«åœ"; if (!isPaused) { startTime = Date.now() - (19.62 + timeBonus - lastRemain) * 1000; gameLoop(); } };

    window.onkeydown = e => { if(e.key==='ArrowLeft') keys.left=true; if(e.key==='ArrowRight') keys.right=true; if(e.key==='Shift') keys.shift=true; };
    window.onkeyup = e => { if(e.key==='ArrowLeft') keys.left=false; if(e.key==='ArrowRight') keys.right=false; if(e.key==='Shift') keys.shift=false; };

    window.startGame = () => { if (!audioCtx) audioCtx = new AudioContext(); currentDiff = parseFloat(document.querySelector('input[name="diff"]:checked').value); document.getElementById('mainMenu').classList.add('hidden'); startLevelFlow(0); };

    async function startLevelFlow(idx) {
        isPlaying = false;
        objects = [];
        currentLevel = idx; currentCharIdx = 0; timeBonus = 0;
        document.getElementById('levelDisplay').innerText = `ç¬¬ ${idx + 1} é—œ`;
        document.getElementById('transitionOverlay').classList.add('hidden');
        document.getElementById('transitionApple').classList.remove('active');
        
        const cd = document.getElementById('countdownOverlay'); cd.classList.remove('hidden');
        const steps = [`ç¬¬ ${idx+1} é—œ`, "READY?", "3", "2", "1", "GO!"];
        for (let s of steps) { cd.innerText = s; playB(s==="GO!"?800:440, 0.1); await new Promise(r => setTimeout(r, 650)); }
        cd.classList.add('hidden');
        
        startTime = Date.now(); isPlaying = true; updateUI(); gameLoop();
    }

    function gameLoop() {
        if (!isPlaying || isPaused) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const remain = Math.max(0, 19.62 + timeBonus - (Date.now() - startTime)/1000);
        lastRemain = remain;
        document.getElementById('timeDisplay').innerText = `${remain.toFixed(2)}s`;
        if (remain <= 0) { isPlaying = false; alert("æ™‚é–“åˆ°ï¼é‡å•Ÿå¯¦é©—ã€‚"); startLevelFlow(currentLevel); return; }

        const spd = keys.shift ? canvas.width * 0.038 : canvas.width * 0.007;
        if (keys.left) player.x -= spd; if (keys.right) player.x += spd;
        player.x = Math.max(30, Math.min(canvas.width - 30, player.x));

        ctx.font = "60px Arial"; ctx.textAlign = "center";
        ctx.fillText("ğŸ", player.x, player.y);

        for (let i = objects.length - 1; i >= 0; i--) {
            const o = objects[i]; o.y += o.speed;
            ctx.font = "bold 40px Arial"; ctx.fillStyle = (o.char === formulas[currentLevel][currentCharIdx]) ? "#f1c40f" : "white";
            ctx.fillText(o.char, o.x, o.y);
            if (Math.abs(player.x - o.x) < 45 && Math.abs(player.y - o.y) < 45) { catchObj(o); objects.splice(i, 1); }
            else if (o.y > canvas.height + 50) objects.splice(i, 1);
        }
        if (Math.random() < 0.06) objects.push({ char: (Math.random()<0.68?formulas[currentLevel][currentCharIdx]:(Math.random()<0.06?'â°':'X')), x: Math.random()*canvas.width, y: -50, speed: 4+Math.random()*3+(currentDiff/10) });
        requestAnimationFrame(gameLoop);
    }

    function catchObj(o) {
        if (o.char === 'â°') { timeBonus += 3; playB(900, 0.1); return; }
        if (o.char === formulas[currentLevel][currentCharIdx]) {
            currentCharIdx++; timeBonus += 0.5; playB(700, 0.08);
            if (currentCharIdx >= formulas[currentLevel].length) {
                isPlaying = false; 
                levelTimes[currentLevel] = (Date.now() - startTime) / 1000;
                objects = [];
                showTransition();
            } else updateUI();
        } else { timeBonus -= 1.5; playB(150, 0.2); if (currentDiff >= 19.62) { currentCharIdx = 0; updateUI(); } }
    }

    function showTransition() {
        const trans = document.getElementById('transitionOverlay');
        const apple = document.getElementById('transitionApple');
        trans.classList.remove('hidden');
        document.getElementById('stageTimeSummary').innerText = `æœ¬é—œè€—æ™‚: ${levelTimes[currentLevel].toFixed(2)}s`;
        
        setTimeout(() => {
            if (!trans.classList.contains('hidden')) apple.classList.add('active');
        }, 1500);

        const nextBtn = document.getElementById('nextLevelBtn');
        nextBtn.onclick = () => (currentLevel < 3) ? startLevelFlow(currentLevel + 1) : showFinal();
    }

    function updateUI() {
        const f = formulas[currentLevel]; let h = "";
        f.forEach((c, i) => { h += (i < currentCharIdx) ? `<span style="color:#2ecc71">${c}</span>` : (i === currentCharIdx) ? `<span class="next-char">${c}</span>` : `<span style="opacity:0.2">${c}</span>`; });
        document.getElementById('targetEquation').innerHTML = h;
    }

    async function showFinal() {
        document.getElementById('transitionOverlay').classList.add('hidden');
        const res = document.getElementById('resultOverlay'); res.classList.remove('hidden');
        let total = 0; const tbl = document.getElementById('statsTable'); tbl.innerHTML = "";
        levelTimes.forEach((t, i) => { total += t; tbl.innerHTML += `<tr><td>é—œå¡ ${i+1}</td><td style='text-align:right'>${t.toFixed(2)}s</td></tr>`; });
        document.getElementById('totalScoreText').innerText = `ç¸½æˆç¸¾ï¼š${total.toFixed(2)}s`;
        const url = window.location.href; document.getElementById('qrcode').src = `https://api.qrserver.com/v1/create-qr-code/?size=90x90&data=${encodeURIComponent(url)}`;
        document.getElementById('waShare').onclick = () => window.open(`https://wa.me/?text=${encodeURIComponent('ğŸ è˜‹æœçš„è€ƒé©—æˆåŠŸï¼ç¸½è€—æ™‚ '+total.toFixed(2)+'sã€‚ä½ ä¹Ÿä¾†è©¦è©¦ï¼š'+url)}`);
        try { await addDoc(collection(db, "physics_leaderboard"), { name: (document.getElementById('playerName').value || "ANONYMOUS"), totalTime: total.toFixed(2), compositeScore: 1000000-Math.floor(total*100), difficulty: currentDiff, timestamp: new Date() }); } catch(e) {}
    }

    window.exitToHome = () => { document.getElementById('resultOverlay').classList.add('hidden'); document.getElementById('quoteOverlay').classList.remove('hidden'); setTimeout(() => location.reload(), 4500); };
</script>
</body>
</html>
