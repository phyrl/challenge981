<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>è˜‹æœçš„è€ƒé©— V0.6.6.10</title>
<style>
    :root { --accent: #e74c3c; --gold: #f1c40f; --bg: #0d0d0d; --cert-bg: #1a1a1a; }
    * { -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
    body { margin: 0; background: var(--bg); color: white; font-family: 'Segoe UI', Arial, sans-serif; overflow: hidden; touch-action: none; position: fixed; width: 100%; height: 100%; }
    #gameContainer { position: relative; width: 100vw; height: 100vh; overflow: hidden; background: #000; }
    canvas { display: block; width: 100%; height: 100%; }

    /* UI é ‚éƒ¨ */
    #ui { position: absolute; top: 12px; left: 15px; right: 15px; display: flex; justify-content: space-between; align-items: center; z-index: 50; pointer-events: none; }
    .ui-group { display: flex; gap: 8px; pointer-events: auto; }
    .ui-item { background: rgba(0,0,0,0.6); padding: 6px 14px; border-radius: 20px; font-weight: bold; border: 1px solid rgba(255,255,255,0.2); font-size: 14px; }
    .ui-btn { cursor: pointer; background: var(--accent); color: white; border: none; padding: 5px 12px; border-radius: 10px; font-weight: bold; transition: 0.2s; }

    /* å…¬å¼èˆ‡å„€å¼æ„Ÿ */
    #equationHeader { position: absolute; top: 60px; left: 0; right: 0; text-align: center; z-index: 40; pointer-events: none; }
    #targetEquation { font-size: clamp(14px, 4.5vw, 28px); font-weight: bold; color: var(--gold); background: rgba(0,0,0,0.85); padding: 10px 15px; border-radius: 12px; display: inline-block; min-width: 85%; border: 1px solid rgba(255,255,255,0.1); }
    .next-char { color: #fff; text-decoration: underline; text-underline-offset: 6px; animation: blink 0.8s infinite; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

    /* æ§åˆ¶å™¨ */
    #controls { position: fixed; bottom: 30px; left: 0; right: 0; display: flex; justify-content: center; gap: 10px; z-index: 200; pointer-events: none; }
    .control-btn { width: 68px; height: 68px; border-radius: 15px; background: rgba(50,50,50,0.8); color: white; font-size: 24px; display: flex; justify-content: center; align-items: center; pointer-events: auto; cursor: pointer; border: 2px solid rgba(255,255,255,0.3); }

    /* Overlays */
    .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.96); display: flex; flex-direction: column; align-items: center; text-align: center; z-index: 100; padding: 20px; box-sizing: border-box; backdrop-filter: blur(10px); justify-content: flex-start; padding-top: 5vh; overflow-y: auto; }
    .hidden { display: none !important; }
    .btn-apple { padding: 14px 40px; font-size: 18px; cursor: pointer; border: none; border-radius: 50px; background: var(--accent); color: white; font-weight: bold; margin: 8px; width: 85%; max-width: 280px; }
    
    /* ç‰©ç†è‡ªç”±è½é«”éå ´è˜‹æœ */
    #transitionApple { position: absolute; right: 15%; top: -100px; font-size: 80px; transition: top 1.8s cubic-bezier(0.5, 0, 1, 0.5); opacity: 0; z-index: 110; }
    .apple-active { top: 70% !important; opacity: 1 !important; }

    .certificate { background: var(--cert-bg); border: 4px double var(--gold); padding: 20px; border-radius: 15px; width: 95%; max-width: 340px; margin: 10px 0; box-shadow: 0 0 25px rgba(241, 196, 15, 0.4); }
    .float-msg { position: absolute; pointer-events: none; font-weight: bold; animation: floatUp 1s forwards; z-index: 60; font-size: 24px; text-shadow: 2px 2px 4px black; }
    @keyframes floatUp { from { opacity:1; transform:translateY(0); } to { opacity:0; transform:translateY(-60px); } }
</style>
</head>
<body oncontextmenu="return false;">

<div id="gameContainer">
    <div id="ui">
        <div class="ui-item" id="levelDisplay">ç¬¬ 1 é—œ</div>
        <div class="ui-item" id="timeDisplay">19.62s</div>
        <div class="ui-group">
            <button class="ui-btn" id="soundToggle" onclick="window.toggleSound()">ğŸ”Š</button>
            <button class="ui-btn" id="pauseBtn" onclick="window.togglePause()">â¸</button>
        </div>
    </div>

    <div id="equationHeader"><div id="targetEquation">è¼‰å…¥ä¸­...</div></div>
    <div id="countdownOverlay" class="hidden" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:60px; font-weight:bold; color:var(--accent); z-index:300; text-align:center;"></div>
    <div id="msgContainer"></div>
    <canvas id="gameCanvas"></canvas>

    <div id="controls">
        <div class="control-btn" id="btnFastLeft">â—€â—€</div>
        <div class="control-btn" id="btnLeft">â—€</div>
        <div class="control-btn" id="btnRight">â–¶</div>
        <div class="control-btn" id="btnFastRight">â–¶â–¶</div>
    </div>

    <div id="mainMenu" class="overlay">
        <h1 style="color:var(--accent); font-size:42px; margin:0;">ğŸ è˜‹æœçš„è€ƒé©—</h1>
        <p style="color:var(--gold); font-style: italic;">ã€Œç ”ç¿’ç‰©ç†ï¼Œéœ€å¿ƒç„¡æ—é¶©ã€‚ã€</p>
        <input type="text" id="playerName" placeholder="ä½ çš„åå­—" maxlength="10" style="width:220px; padding:12px; border-radius:10px; text-align:center; font-size:18px; margin:15px 0; border:1px solid #444; background:#222; color:white;">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; width:90%; max-width:320px; margin:10px 0;">
            <label><input type="radio" name="diff" value="0" checked> é›£åº¦ 0</label>
            <label><input type="radio" name="diff" value="9.81"> é›£åº¦ 9.81</label>
            <label><input type="radio" name="diff" value="19.62"> é›£åº¦ 19.62</label>
            <label><input type="radio" name="diff" value="29.43"> é›£åº¦ 29.43</label>
        </div>
        <button class="btn-apple" onclick="window.startGame()">é–‹å§‹è€ƒé©—</button>
        <button class="btn-apple" style="background:#34495e;" onclick="window.toggleRules()">è€ƒé©—æ–¹å¼</button>
        <button class="btn-apple" style="background:#2980b9;" onclick="window.toggleLeaderboard()">ğŸ† æ’è¡Œæ¦œ</button>
        <button class="btn-apple" id="menuSoundBtn" style="background:#555; padding: 10px 20px; font-size: 16px;" onclick="window.toggleSound()">ğŸ”Š éŸ³æ•ˆï¼šé–‹å•Ÿ</button>
    </div>

    <div id="rulesOverlay" class="overlay hidden">
        <h2 style="color:var(--gold);">è€ƒé©—æ–¹å¼</h2>
        <div style="text-align:left; font-size:15px; line-height:1.8; max-width:300px; padding:15px; background:rgba(255,255,255,0.05); border-radius:15px;">
            1. å·¦å³ç§»å‹•æ¥ä½é‡‘è‰²ç¬¦è™Ÿå®Œæˆå…¬å¼ã€‚<br>
            2. â° å¢åŠ  3 ç§’æ™‚é–“ã€‚<br>
            3. ğŸ›¡ï¸ è­·ç›¾æŠµæ¶ˆä¸€æ¬¡éŒ¯èª¤ (19.62+)ã€‚<br>
            4. é›£åº¦è¶Šé«˜ï¼Œæ¥éŒ¯æœƒé‡ç½®å…¬å¼é€²åº¦ã€‚<br>
            5. **Shift / â—€â—€** å¯é€²è¡Œ 5 å€é€Ÿä½ç§»ã€‚<br>
            6. æ¯é—œçš„çµç®—æ™‚é–“å°‡æœƒåŒ…å«å¤±æ•—é‡è©¦çš„ç¸½æ™‚é–“ã€‚<br>
            7. **æ‰‹æ©Ÿ/å¹³æ¿ç©å®¶å¯ç›´æ¥é»æ“Šè¢å¹•å·¦/å³åŠé‚Šé€²è¡Œç§»å‹•ã€‚**
        </div>
        <button class="btn-apple" onclick="window.toggleRules()">è¿”å›</button>
    </div>

    <div id="leaderboardOverlay" class="overlay hidden">
        <h2 style="color:var(--gold);">ğŸ… ç‰©ç†å­¸éœ¸æ’è¡Œæ¦œ</h2>
        <div id="leaderboardContent" style="background:rgba(255,255,255,0.05); padding:15px; border-radius:15px; margin:15px 0; width:90%; max-width:340px; max-height:50vh; overflow-y:auto; font-size:15px;">
            è¼‰å…¥ä¸­...
        </div>
        <button class="btn-apple" id="lbCloseBtn" onclick="window.toggleLeaderboard()">è¿”å›</button>
    </div>

    <div id="transitionOverlay" class="overlay hidden">
        <div id="transitionApple">ğŸ</div>
        <h2 style="color:var(--gold); margin-top:50px;" id="transMsg">æ•¸æ“šæ¡é›†å®Œæˆ</h2>
        <div style="background:rgba(255,255,255,0.05); padding:20px; border-radius:15px; margin:20px 0; width:80%;">
            <p id="stageTimeSummary" style="font-size:24px; font-weight:bold; margin:10px 0;"></p>
            <p id="congratsText" style="color:var(--accent); font-weight:bold;"></p>
        </div>
        <button class="btn-apple" id="nextLevelBtn" style="opacity:0; transition: opacity 0.5s;">ç¹¼çºŒè€ƒé©—</button>
    </div>

    <div id="resultOverlay" class="overlay hidden">
        <div class="certificate">
            <div id="rankLabel" style="font-size: 20px; color: var(--accent); font-weight: bold; border: 1px solid var(--accent); display: inline-block; padding: 2px 12px; border-radius: 5px;">ç‰©ç†å­¸éœ¸</div>
            <h2 style="color:var(--gold); margin:10px 0;">ç‰©ç†æˆå°±è­‰æ›¸</h2>
            <div style="font-size:16px; margin:10px 0;">èŒ²è­‰æ˜ <span id="certPlayerName" style="color:var(--gold); font-weight:bold;"></span> æˆåŠŸé€šéè€ƒé©—ï¼</div>
            <div style="font-size:18px;">ç¸½æ™‚é–“ï¼š<span id="certTotalTime" style="color:var(--accent); font-weight:bold;"></span>s | é›£åº¦ï¼š<span id="certDiff"></span></div>
            <div style="margin-top:12px;"><img id="qrcode" src="" alt="QR" width="85" style="background:white; padding:4px; border-radius:5px;"></div>
        </div>
        <button class="btn-apple" style="background:linear-gradient(45deg, #f09433, #bc1888);" onclick="window.copyToIG()">ğŸ“‹ è¤‡è£½æˆç¸¾åˆ†äº« IG Story</button>
        <button class="btn-apple" style="background:#34495e;" onclick="window.goToEndGameLeaderboard()">æŸ¥çœ‹æ’è¡Œæ¦œ</button>
    </div>

    <div id="quoteOverlay" class="overlay hidden" style="justify-content:center; padding-top:0;">
        <div style="font-size:22px; color:var(--gold); letter-spacing:4px; line-height:2.2; text-align:center;">ã€Œç ”ç¿’ç‰©ç†ï¼Œéœ€å¿ƒç„¡æ—é¶©ã€‚ã€<br>ã€Œå¬‰æˆ²ä¹‹æ™‚ï¼Œè«å¿˜æ¢ç´¢çœŸç†ã€‚ã€</div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDoHHh-8Gm5tt_uWF4IPGIGfOTNYnAgHr4",
      authDomain: "physicsgame-rl.firebaseapp.com",
      projectId: "physicsgame-rl",
      storageBucket: "physicsgame-rl.firebasestorage.app",
      messagingSenderId: "68402923149",
      appId: "1:68402923149:web:0bb2be531b9e971a6544c4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const formulas = [['v', '=', 'u', '+', 'a', 't'], ['s', '=', 'Â½', '(', 'u', '+', 'v', ')', 't'], ['s', '=', 'u', 't', '+', 'Â½', 'a', 't', 'Â²'], ['v', 'Â²', '=', 'u', 'Â²', '+', '2', 'a', 's']];
    const distMap = { 'v':['u','a'],'u':['v','s'],'s':['d','h'],'a':['g','f'],'t':['x','y'] };

    let isPlaying = false, isPaused = false, currentLevel = 0, currentCharIdx = 0, startTime, timeBonus = 0;
    let levelTimes = [0,0,0,0], objects = [], combo = 0, hasShield = false;
    let audioCtx = null, currentDiff = 0, lastSpawnedIdx = -1;
    let endGameFlow = false; 
    const keys = { left: false, right: false, shift: false };
    const player = { x: 0, y: 0 };

    let isMuted = localStorage.getItem('physicsGameMuted') === 'true';
    document.getElementById('soundToggle').innerText = isMuted ? "ğŸ”‡" : "ğŸ”Š";
    const menuBtn = document.getElementById('menuSoundBtn');
    if(menuBtn) menuBtn.innerText = isMuted ? "ğŸ”‡ éŸ³æ•ˆï¼šé—œé–‰" : "ğŸ”Š éŸ³æ•ˆï¼šé–‹å•Ÿ";

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; player.x = canvas.width/2; player.y = canvas.height - 180; }
    window.addEventListener('resize', resize); resize();

    function playSound(f, d, type = 'sine') {
        if (!audioCtx || isMuted) return;
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.type = type; o.frequency.setValueAtTime(f + (combo * 35), audioCtx.currentTime);
        g.gain.setValueAtTime(0.05, audioCtx.currentTime); 
        g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + d);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + d);
    }

    window.toggleSound = () => { 
        isMuted = !isMuted; 
        localStorage.setItem('physicsGameMuted', isMuted);
        document.getElementById('soundToggle').innerText = isMuted ? "ğŸ”‡" : "ğŸ”Š"; 
        const menuBtn = document.getElementById('menuSoundBtn');
        if(menuBtn) menuBtn.innerText = isMuted ? "ğŸ”‡ éŸ³æ•ˆï¼šé—œé–‰" : "ğŸ”Š éŸ³æ•ˆï¼šé–‹å•Ÿ";
    };
    
    window.togglePause = () => { if(!isPlaying) return; isPaused = !isPaused; document.getElementById('pauseBtn').innerText = isPaused ? "â–¶" : "â¸"; };
    window.toggleRules = () => document.getElementById('rulesOverlay').classList.toggle('hidden');
    
    window.goToEndGameLeaderboard = () => {
        document.getElementById('resultOverlay').classList.add('hidden');
        window.toggleLeaderboard();
    };

    window.toggleLeaderboard = async () => {
        const overlay = document.getElementById('leaderboardOverlay');
        if (overlay.classList.contains('hidden')) {
            overlay.classList.remove('hidden');
            
            const btn = document.getElementById('lbCloseBtn');
            if (endGameFlow) {
                btn.innerText = "ç¹¼çºŒ";
                btn.onclick = window.exitToHome;
            } else {
                btn.innerText = "è¿”å›";
                btn.onclick = () => overlay.classList.add('hidden');
            }

            const content = document.getElementById('leaderboardContent');
            content.innerHTML = '<div style="text-align:center; color:var(--gold);">æ•¸æ“šæ¡é›†ä¸­...</div>';
            try {
                const q = query(collection(db, "physics_leaderboard"), orderBy("totalTime", "asc"), limit(10));
                const snap = await getDocs(q);
                if (snap.empty) {
                    content.innerHTML = '<div style="text-align:center;">æš«ç„¡å¯¦é©—æ•¸æ“š</div>';
                    return;
                }
                let html = '<table style="width:100%; border-collapse:collapse; text-align:center;">';
                html += '<tr style="border-bottom:1px solid #555; color:var(--accent);"><th>æ’å</th><th>åå­—</th><th>æ™‚é–“</th><th>é›£åº¦</th></tr>';
                let rank = 1;
                snap.forEach(doc => {
                    const data = doc.data();
                    // ğŸŒŸ ä¿®æ­£ 1ï¼šåå­—é¡¯ç¤ºé•·åº¦æ”¹ç‚º 10
                    const dispName = data.name ? data.name.substring(0,10) : 'ç„¡å';
                    // ğŸŒŸ ç¢ºä¿æ™‚é–“é¡¯ç¤ºç‚ºæ•¸å­—æ ¼å¼
                    html += `<tr><td style="padding:6px 0;">${rank}</td><td>${dispName}</td><td>${Number(data.totalTime).toFixed(2)}s</td><td>${data.difficulty}</td></tr>`;
                    rank++;
                });
                html += '</table>';
                content.innerHTML = html;
            } catch(e) {
                content.innerHTML = '<div style="text-align:center; color:red;">è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡æˆ–æ•¸æ“šåº«è¨­å®šã€‚</div>';
            }
        } else {
            overlay.classList.add('hidden');
        }
    };

    window.startGame = () => { 
        levelTimes = [0,0,0,0]; 
        endGameFlow = false;
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        currentDiff = parseFloat(document.querySelector('input[name="diff"]:checked').value);
        document.getElementById('mainMenu').classList.add('hidden');
        startLevelFlow(0);
    };

    async function startLevelFlow(idx) {
        isPlaying = false; objects = []; currentLevel = idx; currentCharIdx = 0; lastSpawnedIdx = -1; timeBonus = 0; combo = 0; hasShield = false;
        keys.left = false; keys.right = false; keys.shift = false;
        document.getElementById('transitionOverlay').classList.add('hidden');
        document.getElementById('transitionApple').classList.remove('apple-active');
        document.getElementById('levelDisplay').innerText = `ç¬¬ ${idx + 1} é—œ`;
        updateUI();
        const cd = document.getElementById('countdownOverlay'); cd.classList.remove('hidden');
        for (let s of [`ç¬¬ ${idx+1} é—œ`, "READY?", "3", "2", "1", "GO!"]) { cd.innerText = s; playSound(440, 0.2); await new Promise(r => setTimeout(r, 650)); }
        cd.classList.add('hidden'); startTime = Date.now(); isPlaying = true; gameLoop();
    }

    function gameLoop() {
        if (!isPlaying || isPaused) { if(isPlaying) requestAnimationFrame(gameLoop); return; }
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const remain = Math.max(0, 19.62 + timeBonus - (Date.now() - startTime)/1000);
        document.getElementById('timeDisplay').innerText = `${remain.toFixed(2)}s`;
        
        if (remain <= 0) { 
            isPlaying = false; 
            levelTimes[currentLevel] += (Date.now() - startTime)/1000; 
            alert("è€ƒé©—å¤±æ•—ï¼"); 
            startLevelFlow(currentLevel); 
            return; 
        }

        let baseMove = canvas.width * 0.005;
        let moveSpeed = baseMove * (keys.shift ? 5 : 1);
        if (keys.left) player.x -= moveSpeed; 
        if (keys.right) player.x += moveSpeed;
        player.x = Math.max(30, Math.min(canvas.width - 30, player.x));

        ctx.font = "60px Arial"; ctx.textAlign = "center";
        if (hasShield) { ctx.shadowBlur = 15; ctx.shadowColor = "cyan"; }
        ctx.fillText("ğŸ", player.x, player.y); ctx.shadowBlur = 0;

        const f = formulas[currentLevel];
        let correctObjs = objects.filter(o => o.isCorrect);
        if (correctObjs.length === 0 || (correctObjs[correctObjs.length-1].y > canvas.height/3.5)) {
            if (lastSpawnedIdx < f.length - 1) spawn(lastSpawnedIdx + 1, true);
        }
        if (Math.random() < 0.004) spawn(currentCharIdx, true); 

        for (let i = objects.length - 1; i >= 0; i--) {
            const o = objects[i]; o.y += o.speed || 4;
            ctx.font = "bold 38px Arial"; 
            ctx.fillStyle = o.isCorrect ? "#f1c40f" : (o.char==='â°'||o.char==='ğŸ›¡ï¸'?"cyan":"rgba(255,255,255,0.4)");
            ctx.fillText(o.char, o.x, o.y);
            if (Math.abs(player.x - o.x) < 45 && Math.abs(player.y - o.y) < 45) { catchObj(o); objects.splice(i, 1); }
            else if (o.y > canvas.height + 50) { if (o.isCorrect && o.idx === currentCharIdx) lastSpawnedIdx = currentCharIdx - 1; objects.splice(i, 1); }
        }
        if (Math.random() < 0.02) spawnDistractor();
        requestAnimationFrame(gameLoop);
    }

    function spawn(idx, isCorrect) {
        objects.push({ char: formulas[currentLevel][idx], x: 50+Math.random()*(canvas.width-100), y: -50, isCorrect, idx, speed: 3.5+(currentDiff/10) });
        if (isCorrect) lastSpawnedIdx = Math.max(lastSpawnedIdx, idx);
    }

    function spawnDistractor() {
        const pool = distMap[formulas[currentLevel][currentCharIdx]] || ['X'];
        let char = (Math.random() < 0.7) ? pool[Math.floor(Math.random()*pool.length)] : 'X';
        if (Math.random() < 0.08) char = 'â°';
        if (currentDiff >= 19.62 && Math.random() < 0.04) char = 'ğŸ›¡ï¸';
        objects.push({ char, x: 30+Math.random()*(canvas.width-60), y: -50, isCorrect: false, speed: 4+Math.random()*2 });
    }

    function catchObj(o) {
        if (o.char === 'â°') { timeBonus += 3; msg("â° +3s", "#f1c40f"); playSound(800, 0.2, 'square'); return; }
        if (o.char === 'ğŸ›¡ï¸') { hasShield = true; msg("ğŸ›¡ï¸ SHIELD!", "cyan"); playSound(1200, 0.2); return; }
        const f = formulas[currentLevel];
        if (o.isCorrect && o.idx === currentCharIdx) {
            currentCharIdx++; combo++; timeBonus += 0.5;
            let comboTxt = combo > 1 ? ` COMBO x${combo}` : '';
            msg(`+0.5s${comboTxt}`, "#2ecc71"); 
            playSound(600, 0.1);
            if (currentCharIdx >= f.length) { 
                isPlaying = false; 
                levelTimes[currentLevel] += (Date.now() - startTime)/1000; 
                showTransition(); 
            } else updateUI();
        } else {
            if (hasShield) { hasShield = false; msg("ğŸ›¡ï¸ LOST", "white"); playSound(300, 0.3); }
            else { if (currentDiff >= 19.62) { currentCharIdx = 0; lastSpawnedIdx = -1; updateUI(); } if (currentDiff > 0) timeBonus -= 1.5; }
            combo = 0; msg("-1.5s MISS", "red"); playSound(200, 0.3);
        }
    }

    function showTransition() {
        const overlay = document.getElementById('transitionOverlay');
        const apple = document.getElementById('transitionApple');
        const btn = document.getElementById('nextLevelBtn');
        overlay.classList.remove('hidden');
        document.getElementById('stageTimeSummary').innerText = `ç´¯ç©è€—æ™‚: ${levelTimes[currentLevel].toFixed(2)}s`;
        if (currentLevel < 3) {
            document.getElementById('transMsg').innerText = "é—œå¡å®Œæˆï¼";
            document.getElementById('congratsText').innerText = "";
            btn.innerText = "ç¹¼çºŒè€ƒé©—";
            btn.onclick = () => startLevelFlow(currentLevel + 1);
        } else {
            document.getElementById('transMsg').innerText = "ğŸ† å¤§ç²å…¨å‹ï¼";
            document.getElementById('congratsText').innerText = "ä½ æ˜¯çœŸæ­£çš„ç‰›é “æ¥ç­äººï¼";
            btn.innerText = "ç”Ÿæˆæˆå°±è­‰æ›¸";
            btn.onclick = () => showFinal();
        }
        btn.style.opacity = "0";
        setTimeout(() => { apple.classList.add('apple-active'); }, 1500);
        setTimeout(() => { btn.style.opacity = "1"; }, 2500);
    }

    async function showFinal() {
        endGameFlow = true; 
        document.getElementById('transitionOverlay').classList.add('hidden');
        document.getElementById('resultOverlay').classList.remove('hidden');
        let total = 0; levelTimes.forEach(t => total += t);
        const name = document.getElementById('playerName').value || "ANONYMOUS";
        let rankText = "ç‰©ç†å­¸éœ¸";
        try {
            const q = query(collection(db, "physics_leaderboard"), orderBy("totalTime", "asc"), limit(10));
            const snap = await getDocs(q);
            const scores = snap.docs.map(d => parseFloat(d.data().totalTime));
            if (scores.length > 0 && total < scores[0]) rankText = "ç‰›é “æ¥ç­äºº";
            else if (scores.length < 10 || total < scores[scores.length-1]) rankText = "ç‰©ç†å¤©æ‰";
            
            // ğŸŒŸ ä¿®æ­£ 2ï¼šç¢ºä¿å„²å­˜è‡³ Firebase çš„æ™‚é–“æ ¼å¼ç‚º Number (parseFloat)
            await addDoc(collection(db, "physics_leaderboard"), { name, totalTime: parseFloat(total.toFixed(2)), difficulty: currentDiff, timestamp: new Date() });
        } catch(e) {}
        document.getElementById('rankLabel').innerText = rankText;
        document.getElementById('certPlayerName').innerText = name;
        document.getElementById('certTotalTime').innerText = total.toFixed(2);
        document.getElementById('certDiff').innerText = currentDiff;
        document.getElementById('qrcode').src = `https://api.qrserver.com/v1/create-qr-code/?size=85x85&data=${encodeURIComponent(window.location.href)}`;
    }

    window.exitToHome = () => { 
        document.getElementById('resultOverlay').classList.add('hidden'); 
        document.getElementById('leaderboardOverlay').classList.add('hidden'); 
        document.getElementById('quoteOverlay').classList.remove('hidden'); 
        setTimeout(() => location.reload(), 4500); 
    };
    
    function msg(t, c) {
        const d = document.createElement('div'); d.className = 'float-msg'; d.innerText = t; d.style.color = c;
        d.style.left = player.x + 'px'; d.style.top = player.y - 40 + 'px';
        document.getElementById('msgContainer').appendChild(d); setTimeout(() => d.remove(), 1000);
    }
    
    function updateUI() {
        const f = formulas[currentLevel];
        document.getElementById('targetEquation').innerHTML = f.map((c, i) => (i < currentCharIdx) ? `<span style="color:#2ecc71">${c}</span>` : (i === currentCharIdx) ? `<span class="next-char">${c}</span>` : `<span style="opacity:0.2">${c}</span>`).join('');
    }
    
    window.addEventListener('keydown', e => { if (e.key === 'ArrowLeft') keys.left = true; if (e.key === 'ArrowRight') keys.right = true; if (e.shiftKey) keys.shift = true; });
    window.addEventListener('keyup', e => { if (e.key === 'ArrowLeft') keys.left = false; if (e.key === 'ArrowRight') keys.right = false; if (!e.shiftKey) keys.shift = false; });
    
    const bindBtn = (id, k) => { 
        const el = document.getElementById(id); 
        const press = (e) => { e.preventDefault(); keys[k]=true; if(id.includes('Fast')) keys.shift=true; }; 
        const release = (e) => { e.preventDefault(); keys[k]=false; keys.shift=false; }; 
        el.onpointerdown = press; 
        el.onpointerup = release; 
        el.onpointerleave = release;
        el.onpointercancel = release;
    };
    bindBtn('btnLeft', 'left'); bindBtn('btnRight', 'right'); bindBtn('btnFastLeft', 'left'); bindBtn('btnFastRight', 'right');

    const screenTouchStart = (e) => {
        if (!isPlaying || isPaused) return;
        if (e.clientX < canvas.width / 2) {
            keys.left = true;
        } else {
            keys.right = true;
        }
    };
    const screenTouchEnd = () => {
        keys.left = false;
        keys.right = false;
    };
    
    canvas.addEventListener('pointerdown', screenTouchStart);
    canvas.addEventListener('pointerup', screenTouchEnd);
    canvas.addEventListener('pointerleave', screenTouchEnd);
    canvas.addEventListener('pointercancel', screenTouchEnd);

</script>
</body>
</html>
