<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>è˜‹æœçš„è€ƒé©— V0.6.1.3</title>
<style>
    :root { --accent: #e74c3c; --gold: #f1c40f; }
    body { margin: 0; padding: 0; background-color: #121212; display: flex; justify-content: center; align-items: center; height: 100vh; height: 100dvh; font-family: 'Segoe UI', Arial, sans-serif; overflow: hidden; color: white; }
    #gameContainer { position: relative; width: 100vw; height: 100vh; background-color: #1a1a1a; overflow: hidden; }
    canvas { display: block; width: 100%; height: 100%; touch-action: none; }
    #ui { position: absolute; top: 10px; left: 15px; right: 15px; display: flex; justify-content: space-between; font-size: 14px; font-weight: bold; pointer-events: none; z-index: 5; text-shadow: 2px 2px 4px black; }
    #targetEquation { font-size: clamp(14px, 4.5vw, 28px); font-weight: bold; color: var(--gold); background: rgba(0,0,0,0.7); padding: 10px 15px; border-radius: 12px; display: inline-block; min-width: 88%; border: 1px solid rgba(255,255,255,0.1); }
    #equationHeader { position: absolute; top: 40px; left: 0; right: 0; text-align: center; z-index: 5; pointer-events: none; }
    .next-char { color: #fff; text-decoration: underline; text-underline-offset: 5px; animation: blink 0.8s infinite; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.96); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; z-index: 20; padding: 20px; box-sizing: border-box; }
    .hidden { display: none !important; }
    .btn-apple { padding: 12px 30px; font-size: 18px; cursor: pointer; border: none; border-radius: 50px; background: var(--accent); color: white; font-weight: bold; margin: 10px; }
    #countdownOverlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); font-size: 70px; font-weight: bold; color: var(--accent); z-index: 40; pointer-events: none; }
    .diff-group { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin: 10px 0; width: 100%; max-width: 320px; }
    .diff-btn-label { background: #333; padding: 10px; border-radius: 8px; font-size: 12px; cursor: pointer; border: 2px solid transparent; flex: 1 1 45%; }
    input[type="radio"]:checked + .diff-btn-label { border-color: var(--accent); background: #442222; }
    #rulesBox { background: rgba(255,255,255,0.05); border: 1px solid var(--gold); padding: 15px; border-radius: 12px; font-size: 13px; text-align: left; max-width: 400px; margin: 10px 0; line-height: 1.5; }
</style>
</head>
<body>

<div id="gameContainer">
    <div id="ui">
        <div id="levelDisplay">é—œå¡: 1/4</div>
        <div id="timeDisplay">å‰©é¤˜: 19.62s</div>
        <div id="versionTag">V0.6.1.3</div>
    </div>
    <div id="equationHeader"><div id="targetEquation">æº–å‚™æŒ‘æˆ°...</div></div>
    <div id="countdownOverlay" class="hidden"></div>
    <canvas id="gameCanvas"></canvas>

    <div id="mainMenu" class="overlay">
        <h1 style="color:var(--accent); margin:0;">ğŸ è˜‹æœçš„è€ƒé©—</h1>
        <div id="rulesBox">
            <h3 style="margin:0 0 10px 0; text-align:center; color:var(--gold);">ğŸ“œ éŠæˆ²èªªæ˜</h3>
            â€¢ <b>ç›®æ¨™</b>ï¼šä¾åºæ¥ä½æ­£ç¢ºç¬¦è™Ÿå®Œæˆ 4 æ¢ç‰©ç†å…¬å¼ã€‚<br>
            â€¢ <b>æ™‚é–“</b>ï¼šæ¯é—œé–‹å§‹æœ‰ <b>19.62s</b>ã€‚æ­£ç¢º +0.5sï¼Œâ° +3sã€‚<br>
            â€¢ <b>æ“ä½œ</b>ï¼šé›»è…¦ç”¨ â† / â†’ å¾®èª¿ï¼ŒæŒ‰ä½ <b>Shift</b> å¿«é€Ÿè¡åˆºã€‚
        </div>
        <input type="text" id="playerName" maxlength="12" placeholder="è¼¸å…¥å­¸éœ¸åå­—" style="font-size: 18px; padding: 10px; border-radius: 10px; text-align: center; border: none; margin: 5px 0; width: 80%; max-width: 250px;">
        <div class="diff-group">
            <input type="radio" name="diff" value="0" id="d0" checked style="display:none"><label for="d0" class="diff-btn-label">é›£åº¦ 0</label>
            <input type="radio" name="diff" value="9.81" id="d1" style="display:none"><label for="d1" class="diff-btn-label">é›£åº¦ 9.81</label>
            <input type="radio" name="diff" value="19.62" id="d2" style="display:none"><label for="d2" class="diff-btn-label">é›£åº¦ 19.62</label>
            <input type="radio" name="diff" value="29.43" id="d3" style="display:none"><label for="d3" class="diff-btn-label">é›£åº¦ 29.43</label>
        </div>
        <button class="btn-apple" onclick="startGame()">é–‹å§‹æŒ‘æˆ°</button>
    </div>

    <div id="levelClearOverlay" class="overlay hidden">
        <h2 style="color:var(--gold)">é—œå¡å®Œæˆï¼</h2>
        <p id="stageTimeText"></p>
        <button class="btn-apple" id="nextLevelBtn">ä¸‹ä¸€é—œ</button>
    </div>

    <div id="finalOverlay" class="overlay hidden">
        <h1 style="color:var(--gold)">ğŸ† å…¨éƒ¨é€šé—œ</h1>
        <div id="finalStats"></div>
        <button class="btn-apple" onclick="location.reload()">è¿”å›ä¸»é </button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDoHHh-8Gm5tt_uWF4IPGIGfOTNYnAgHr4",
      authDomain: "physicsgame-rl.firebaseapp.com",
      projectId: "physicsgame-rl",
      storageBucket: "physicsgame-rl.firebasestorage.app",
      messagingSenderId: "68402923149",
      appId: "1:68402923149:web:0bb2be531b9e971a6544c4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const formulas = [['v', '=', 'u', '+', 'a', 't'], ['s', '=', 'Â½', '(', 'u', '+', 'v', ')', 't'], ['s', '=', 'u', 't', '+', 'Â½', 'a', 't', 'Â²'], ['v', 'Â²', '=', 'u', 'Â²', '+', '2', 'a', 's']];
    const distMap = { 'v': ['u'], 'u': ['v'], 's': ['d'], 'a': ['g'], 't': ['f'], '=': ['â‰ˆ'], '+': ['-'], 'Â²': ['Â³'], 'Â½': ['â…“'], '2': ['3'] };

    let isPlaying = false, currentLevel = 0, currentCharIdx = 0, startTime = 0, timeBonus = 0;
    let levelTimes = [0,0,0,0], objects = [], currentDiff = 0;
    const player = { x: 0, y: 0, size: 60 };
    const controlState = { left: false, right: false, fastLeft: false, fastRight: false };

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; player.x = canvas.width/2; player.y = canvas.height - 100; }
    window.addEventListener('resize', resize); resize();

    window.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') { if (e.shiftKey) controlState.fastLeft = true; else controlState.left = true; }
        if (e.key === 'ArrowRight') { if (e.shiftKey) controlState.fastRight = true; else controlState.right = true; }
    });
    window.addEventListener('keyup', (e) => { controlState.left = controlState.right = controlState.fastLeft = controlState.fastRight = false; });

    window.startGame = () => {
        currentDiff = parseFloat(document.querySelector('input[name="diff"]:checked').value);
        document.getElementById('mainMenu').classList.add('hidden');
        startLevel(0);
    };

    async function startLevel(idx) {
        isPlaying = false;
        objects = []; // ğŸŒŸ æ ¸å¿ƒä¿®æ­£ï¼šå€’æ•¸å‰ç«‹å³æ¸…ç©ºç‰©ä»¶
        currentLevel = idx; currentCharIdx = 0; timeBonus = 0;
        document.getElementById('levelDisplay').innerText = `é—œå¡: ${currentLevel + 1}/4`;
        
        const count = document.getElementById('countdownOverlay');
        count.classList.remove('hidden');
        const steps = [`ç¬¬ ${idx+1} é—œ`, "READY?", "3", "2", "1", "GO!"];
        for (let s of steps) {
            count.innerText = s;
            await new Promise(r => setTimeout(r, 650));
        }
        count.classList.add('hidden');
        
        startTime = Date.now();
        isPlaying = true;
        updateUI();
        gameLoop();
    }

    function updateUI() {
        const f = formulas[currentLevel];
        let h = "";
        f.forEach((c, i) => {
            if (i < currentCharIdx) h += `<span style="color:#2ecc71">${c}</span>`;
            else if (i === currentCharIdx) h += `<span class="next-char">${c}</span>`;
            else h += `<span style="opacity:0.2">${c}</span>`;
        });
        document.getElementById('targetEquation').innerHTML = h;
    }

    function gameLoop() {
        if (!isPlaying) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const remain = Math.max(0, 19.62 + timeBonus - (Date.now() - startTime)/1000); // ğŸŒŸ 19.62s é–‹å±€
        document.getElementById('timeDisplay').innerText = `å‰©é¤˜: ${remain.toFixed(2)}s`;
        
        if (remain <= 0) { isPlaying = false; alert("æ™‚é–“åˆ°ï¼"); startLevel(currentLevel); return; }

        const micro = canvas.width * 0.009, fast = canvas.width * 0.04;
        if (controlState.fastLeft) player.x -= fast; else if (controlState.left) player.x -= micro;
        if (controlState.fastRight) player.x += fast; else if (controlState.right) player.x += micro;
        player.x = Math.max(30, Math.min(canvas.width - 30, player.x));

        ctx.font = "55px Arial"; ctx.textAlign = "center"; ctx.fillText("ğŸ", player.x, player.y);

        for (let i = objects.length - 1; i >= 0; i--) {
            const o = objects[i]; o.y += o.speed;
            ctx.font = "bold 38px Arial"; ctx.fillStyle = (o.char === formulas[currentLevel][currentCharIdx]) ? "#f1c40f" : "white";
            ctx.fillText(o.char, o.x, o.y);
            if (Math.abs(player.x - o.x) < 40 && Math.abs(player.y - o.y) < 40) {
                handleCatch(o); objects.splice(i, 1);
            } else if (o.y > canvas.height + 50) objects.splice(i, 1);
        }

        if (Math.random() < 0.06) {
            const f = formulas[currentLevel];
            let char = (Math.random() < 0.65) ? f[currentCharIdx] : 'X'; // ğŸŒŸ 65% æ­£ç¢ºç‡ï¼Œè®“å¹²æ“¾é …å‡ºç¾
            if (Math.random() < 0.05) char = 'â°';
            objects.push({ char, x: Math.random()*(canvas.width-40)+20, y: -50, speed: 4 + Math.random()*3 });
        }
        requestAnimationFrame(gameLoop);
    }

    function handleCatch(o) {
        if (o.char === 'â°') { timeBonus += 3; return; }
        if (o.char === formulas[currentLevel][currentCharIdx]) {
            currentCharIdx++; timeBonus += 0.5;
            if (currentCharIdx >= formulas[currentLevel].length) {
                isPlaying = false;
                levelTimes[currentLevel] = (Date.now() - startTime) / 1000;
                showLevelClear();
            } else updateUI();
        } else {
            if (currentDiff >= 19.62) { currentCharIdx = 0; updateUI(); }
            else timeBonus -= 1.5;
        }
    }

    function showLevelClear() {
        objects = []; // ğŸŒŸ æ ¸å¿ƒä¿®æ­£ï¼šéé—œç«‹å³æ¸…ç†
        const overlay = document.getElementById('levelClearOverlay');
        document.getElementById('stageTimeText').innerText = `æœ¬é—œç”¨æ™‚: ${levelTimes[currentLevel].toFixed(2)}s`;
        overlay.classList.remove('hidden');
        document.getElementById('nextLevelBtn').onclick = () => {
            overlay.classList.add('hidden');
            if (currentLevel < 3) startLevel(currentLevel + 1); else showFinal();
        };
    }

    function showFinal() {
        document.getElementById('finalOverlay').classList.remove('hidden');
        let total = 0;
        let html = "<ul style='list-style:none; padding:0;'>";
        levelTimes.forEach((t, i) => { total += t; html += `<li>é—œå¡ ${i+1}: ${t.toFixed(2)}s</li>`; });
        html += `</ul><h2 style='color:var(--accent)'>ç¸½æˆç¸¾: ${total.toFixed(2)}s</h2>`;
        document.getElementById('finalStats').innerHTML = html;
        const name = document.getElementById('playerName').value || "ANONYMOUS";
        addDoc(collection(db, "physics_leaderboard"), { name, totalTime: total.toFixed(2), compositeScore: 1000000-Math.floor(total*100) });
    }
</script>
</body>
</html>
