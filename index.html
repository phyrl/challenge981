<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ËòãÊûúÁöÑËÄÉÈ©ó v0.9.4.1</title>
<style>
    body { margin: 0; padding: 0; background-color: #2c3e50; display: flex; justify-content: center; align-items: center; height: 100vh; height: 100dvh; font-family: 'Segoe UI', Arial, sans-serif; overflow: hidden; color: white; }
    #gameContainer { position: relative; width: 100vw; height: 100vh; background-color: #34495e; overflow: hidden; }
    canvas { display: block; width: 100%; height: 100%; touch-action: none; }
    #ui { position: absolute; top: 10px; left: 15px; right: 15px; display: flex; justify-content: space-between; font-size: 16px; font-weight: bold; pointer-events: none; z-index: 5; }
    #equationHeader { position: absolute; top: 40px; left: 0; right: 0; text-align: center; z-index: 5; pointer-events: none; }
    #targetEquation { font-size: clamp(16px, 5vw, 28px); font-weight: bold; color: #f1c40f; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 10px; display: inline-block; min-width: 85%; line-height: 1.4; }
    .next-char { color: #ffffff; text-decoration: underline; text-underline-offset: 5px; animation: blink 0.8s infinite; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    #countdownOverlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 70px; font-weight: bold; color: #e74c3c; z-index: 30; text-shadow: 0 0 15px rgba(0,0,0,0.5); text-align: center; width: 100%; }
    #controls { position: absolute; bottom: 20px; left: 0; right: 0; display: flex; justify-content: center; gap: 8px; padding: 0 5px; z-index: 10; pointer-events: none; }
    .control-btn { width: 65px; height: 65px; border-radius: 12px; background: rgba(0, 0, 0, 0.6); color: white; font-size: 22px; display: flex; justify-content: center; align-items: center; pointer-events: auto; cursor: pointer; border: 2px solid rgba(255,255,255,0.3); }
    .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 20; padding: 20px; box-sizing: border-box; }
    .start-btn { padding: 12px 40px; font-size: 20px; cursor: pointer; border: none; border-radius: 50px; background-color: #e74c3c; color: white; font-weight: bold; margin-top: 15px; }
    .hidden { display: none !important; }
    .diff-label { background: #444; padding: 8px 10px; border-radius: 8px; cursor: pointer; font-size: 12px; margin: 3px; display: inline-block; border: 2px solid transparent; }
    input[type="radio"]:checked + .diff-label { border-color: #e74c3c; background: #c0392b; }
    #finalTable { width: 100%; max-width: 300px; border-collapse: collapse; margin: 15px 0; font-size: 14px; }
    #finalTable td { padding: 5px; border-bottom: 1px solid rgba(255,255,255,0.2); }
</style>
</head>
<body>

<div id="gameContainer">
    <div id="ui">
        <div id="levelDisplay">ÈóúÂç°: 1/4</div>
        <div id="timeDisplay">Ââ©È§ò: 9.81s</div>
        <div style="font-size: 10px; opacity: 0.5;">v0.9.4.1</div>
    </div>
    <div id="countdownOverlay" class="hidden"></div>
    <div id="equationHeader"><div id="targetEquation">Ê∫ñÂÇô...</div></div>
    <canvas id="gameCanvas"></canvas>
    
    <div id="controls">
        <div class="control-btn" id="btnFastLeft">‚óÄ‚óÄ</div>
        <div class="control-btn" id="btnLeft">‚óÄ</div>
        <div class="control-btn" id="btnRight">‚ñ∂</div>
        <div class="control-btn" id="btnFastRight">‚ñ∂‚ñ∂</div>
    </div>

    <div id="startOverlay" class="overlay">
        <h1 style="color: #e74c3c; margin: 5px 0; font-size: 28px;">üçé ËòãÊûúÁöÑËÄÉÈ©ó</h1>
        <input type="text" id="playerName" maxlength="10" placeholder="Â≠∏Èú∏ÂêçÂ≠ó" style="font-size: 18px; padding: 10px; margin: 15px 0; width: 180px; text-align: center;">
        <div id="difficultyUI">
            <input type="radio" name="diff" value="0" id="d0" checked><label for="d0" class="diff-label">Èõ£Â∫¶ 0</label>
            <input type="radio" name="diff" value="9.81" id="d1"><label for="d1" class="diff-label">9.81</label>
            <input type="radio" name="diff" value="19.62" id="d2"><label for="d2" class="diff-label">19.62</label>
            <input type="radio" name="diff" value="29.43" id="d3"><label for="d3" class="diff-label">29.43</label>
        </div>
        <button class="start-btn" id="realStartBtn">ÈñãÂßãÊåëÊà∞</button>
    </div>

    <div id="levelOverlay" class="overlay hidden">
        <h2 id="levelStatus" style="color: #f1c40f;">Level Clear!</h2>
        <p id="levelCurrentStats"></p>
        <button id="nextBtn" class="start-btn">‰∏ã‰∏ÄÈóú</button>
    </div>

    <div id="finalOverlay" class="overlay hidden">
        <h1 style="color: #e74c3c; margin: 5px 0;">üèÜ Á∏ΩÁµêÊàêÁ∏æ</h1>
        <table id="finalTable"></table>
        <h2 id="finalTotalDisplay" style="color: #f1c40f; margin: 10px 0;"></h2>
        <div id="leaderboard" style="width: 100%; font-size: 12px;">
            <ol id="scoreList" style="text-align: left; display: inline-block; padding-left: 20px;"><li>ËºâÂÖ•Ê¶ú‰∏≠...</li></ol>
        </div>
        <button class="start-btn" onclick="location.reload()">ÂÜçË©¶‰∏ÄÊ¨°</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDoHHh-8Gm5tt_uWF4IPGIGfOTNYnAgHr4",
      authDomain: "physicsgame-rl.firebaseapp.com",
      projectId: "physicsgame-rl",
      storageBucket: "physicsgame-rl.firebasestorage.app",
      messagingSenderId: "68402923149",
      appId: "1:68402923149:web:0bb2be531b9e971a6544c4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const formulas = [['v', '=', 'u', '+', 'a', 't'], ['s', '=', '¬Ω', '(', 'u', '+', 'v', ')', 't'], ['s', '=', 'u', 't', '+', '¬Ω', 'a', 't', '¬≤'], ['v', '¬≤', '=', 'u', '¬≤', '+', '2', 'a', 's']];
    const distMap = { 'v': ['u', 'y'], 'u': ['v', 'w'], 's': ['d', 'h'], 'a': ['g', 'q'], 't': ['f', 'x'], '=': ['‚âà', '-'], '+': ['-', '√ó'], '(': ['{'], ')': ['}'], '¬≤': ['¬≥'], '¬Ω': ['‚Öì'], '2': ['3'] };

    let isPlaying = false, currentLevel = 0, currentCharIdx = 0, startTime = 0, timeBonus = 0;
    let levelAccumulatedTimes = [0, 0, 0, 0];
    let objects = [], player = { x: 0, y: 0, size: 60 }, currentDiff = 0;
    const controlState = { left: false, right: false, fastLeft: false, fastRight: false };

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; player.y = canvas.height - 85; player.x = canvas.width / 2; }
    window.addEventListener('resize', resize); resize();

    const btnMap = { 'btnFastLeft': 'fastLeft', 'btnLeft': 'left', 'btnRight': 'right', 'btnFastRight': 'fastRight' };
    Object.keys(btnMap).forEach(id => {
        const el = document.getElementById(id);
        el.onmousedown = el.ontouchstart = (e) => { e.preventDefault(); controlState[btnMap[id]] = true; };
        el.onmouseup = el.onmouseleave = el.ontouchend = () => controlState[btnMap[id]] = false;
    });
    window.onkeydown = (e) => { if(e.key==='ArrowLeft') { if(e.shiftKey) controlState.fastLeft=true; else controlState.left=true; } if(e.key==='ArrowRight') { if(e.shiftKey) controlState.fastRight=true; else controlState.right=true; } };
    window.onkeyup = (e) => { controlState.left = controlState.right = controlState.fastLeft = controlState.fastRight = false; };

    document.getElementById('realStartBtn').onclick = () => {
        currentDiff = document.querySelector('input[name="diff"]:checked').value;
        document.getElementById('startOverlay').classList.add('hidden');
        loadLevel(0);
    };

    function loadLevel(idx) {
        isPlaying = false;
        currentLevel = idx;
        currentCharIdx = 0;
        timeBonus = 0;
        objects.length = 0; // [‰øÆÊ≠£1] Á¢∫ÂØ¶Ê∏ÖÁ©∫ÊÆòÈ§òÁâ©‰ª∂
        document.getElementById('levelDisplay').innerText = `ÈóúÂç°: ${currentLevel + 1}/4`;
        document.getElementById('levelOverlay').classList.add('hidden');
        updateFormulaUI();
        startCountdown();
    }

    async function startCountdown() {
        const overlay = document.getElementById('countdownOverlay');
        overlay.classList.remove('hidden');
        const steps = ["READY?", "3", "2", "1", "GO!"];
        for (let s of steps) {
            overlay.innerText = s;
            await new Promise(r => setTimeout(r, 650));
        }
        overlay.classList.add('hidden');
        startTime = Date.now();
        isPlaying = true;
        gameLoop();
    }

    function updateFormulaUI() {
        const f = formulas[currentLevel];
        let h = "";
        f.forEach((char, i) => {
            if (i < currentCharIdx) h += `<span style="color:#2ecc71">${char}</span>`;
            else if (i === currentCharIdx) h += `<span class="next-char">${char}</span>`;
            else h += `<span style="opacity:0.2">${char}</span>`;
        });
        document.getElementById('targetEquation').innerHTML = h;
    }

    function gameLoop() {
        if (!isPlaying) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const now = Date.now();
        const remain = Math.max(0, 9.81 + timeBonus - (now - startTime)/1000);
        document.getElementById('timeDisplay').innerText = `Ââ©È§ò: ${remain.toFixed(2)}s`;

        if (remain <= 0) {
            isPlaying = false;
            levelAccumulatedTimes[currentLevel] += (Date.now() - startTime) / 1000; // Âç≥‰ΩøÂ§±Êïó‰πüÁ¥ØÁ©çÊôÇÈñì
            alert("ÊôÇÈñìÂà∞ÔºÅÁ¥ØË®àÊôÇÈñìÂ∑≤Â¢ûÂä†„ÄÇ");
            loadLevel(currentLevel);
            return;
        }

        const micro = canvas.width * 0.012, fast = canvas.width * 0.035;
        if (controlState.fastLeft) player.x -= fast; else if (controlState.left) player.x -= micro;
        if (controlState.fastRight) player.x += fast; else if (controlState.right) player.x += micro;
        player.x = Math.max(30, Math.min(canvas.width - 30, player.x));

        ctx.font = "55px Arial"; ctx.textAlign = "center"; ctx.fillText("üçé", player.x, player.y);

        // [‰øÆÊ≠£2] ÂÑ™ÂåñÂ≠óÂÖÉÂá∫ÁèæÁØÄÂ•è
        let spawnRate = 0.045;
        if (Math.random() < spawnRate) {
            const f = formulas[currentLevel], target = f[currentCharIdx];
            let char = '', type = 'dist';
            const r = Math.random();
            if (r < 0.05) { char = '‚è∞'; type = 'clock'; }
            else if (r < 0.7) { // ÊèêÈ´òÊ≠£Á¢∫Â≠óÂÖÉÊØî‰æã
                // [‰øÆÊ≠£2] Â¢ûÂä†30%Ê©üÁéáÊèêÂâçÂá∫Áèæ‰∏ã‰∏ÄÂÄãÂ≠óÂÖÉ
                if (Math.random() > 0.4 && currentCharIdx + 1 < f.length) char = f[currentCharIdx+1];
                else char = target;
                type = 'correct';
            } else {
                const sims = distMap[target] || ['X'];
                char = sims[Math.floor(Math.random()*sims.length)];
            }
            const speedBase = 0.0035 + (currentLevel * 0.0005); // Èö®ÈóúÂç°Áï•ÂæÆÂä†ÈÄü
            objects.push({ char, type, x: Math.random()*(canvas.width-60)+30, y: -50, speed: canvas.height * speedBase * (0.9 + Math.random()*0.3) });
        }

        for (let i = objects.length - 1; i >= 0; i--) {
            const o = objects[i]; o.y += o.speed;
            if (o.y > canvas.height + 50) { objects.splice(i, 1); continue; }
            
            ctx.font = "bold 38px Arial";
            ctx.fillStyle = (o.char === formulas[currentLevel][currentCharIdx]) ? "#f1c40f" : "white";
            ctx.fillText(o.char, o.x, o.y);

            if (Math.abs(player.x - o.x) < 42 && Math.abs(player.y - o.y) < 42) {
                handleCatch(o);
                objects.splice(i, 1);
            }
        }
        requestAnimationFrame(gameLoop);
    }

    function handleCatch(o) {
        if (o.char === '‚è∞') { timeBonus += 3; return; }
        if (o.char === formulas[currentLevel][currentCharIdx]) {
            currentCharIdx++;
            timeBonus += 0.5;
            if (currentCharIdx >= formulas[currentLevel].length) {
                isPlaying = false;
                const taken = (Date.now() - startTime) / 1000;
                levelAccumulatedTimes[currentLevel] += taken; // [‰øÆÊ≠£3] Á¥ØÁ©çÈóúÂç°ËÄóÊôÇ
                showClear();
            } else updateFormulaUI();
        } else {
            const config = { '0':1.5, '9.81':3.0, '19.62':0, '29.43':0 };
            if (currentDiff >= 19.62) { currentCharIdx = 0; updateFormulaUI(); }
            else timeBonus -= config[currentDiff];
        }
    }

    function showClear() {
        if (currentLevel < 3) {
            document.getElementById('levelOverlay').classList.remove('hidden');
            document.getElementById('levelCurrentStats').innerText = `Êú¨ÈóúÁ¥ØÁ©çËÄóÊôÇ: ${levelAccumulatedTimes[currentLevel].toFixed(2)}Áßí`;
            document.getElementById('nextBtn').onclick = () => loadLevel(currentLevel + 1);
        } else {
            showFinalResult();
        }
    }

    async function showFinalResult() {
        document.getElementById('levelOverlay').classList.add('hidden');
        document.getElementById('finalOverlay').classList.remove('hidden');
        
        const table = document.getElementById('finalTable');
        table.innerHTML = "";
        let total = 0;
        levelAccumulatedTimes.forEach((t, i) => {
            total += t;
            table.innerHTML += `<tr><td>ÈóúÂç° ${i+1}</td><td>${t.toFixed(2)} Áßí</td></tr>`;
        });
        
        document.getElementById('finalTotalDisplay').innerText = `Á∏ΩÊàêÁ∏æ: ${total.toFixed(2)} Áßí`;
        
        const name = document.getElementById('playerName').value.trim().toUpperCase() || "ANON";
        // [‰øÆÊ≠£4] Á∏ΩÊàêÁ∏æÊéíÂ∫èÈÇèËºØ
        const compositeScore = 1000000 - Math.floor(total * 100); 
        await addDoc(collection(db, "physics_leaderboard"), { name, totalTime: total.toFixed(2), difficulty: currentDiff, compositeScore, timestamp: new Date() });
        renderLeaderboard();
    }

    async function renderLeaderboard() {
        try {
            const q = query(collection(db, "physics_leaderboard"), orderBy("compositeScore", "desc"), limit(5));
            const snap = await getDocs(q);
            const list = document.getElementById('scoreList'); list.innerHTML = '';
            snap.forEach(doc => { 
                const d = doc.data(); 
                list.innerHTML += `<li><b>${d.name}</b>: ${d.totalTime}s (Èõ£Â∫¶ ${d.difficulty})</li>`; 
            });
        } catch (e) {}
    }
</script>
</body>
</html>
