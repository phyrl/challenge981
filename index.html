<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ç‰›é “çš„è€ƒé©— - å‹»åŠ é€Ÿå…¬å¼ç‰ˆ</title>
<style>
    body { margin: 0; padding: 0; background-color: #2c3e50; display: flex; justify-content: center; align-items: center; height: 100vh; height: 100dvh; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; color: white; }
    #gameContainer { position: relative; width: 100vw; height: 100vh; background-color: #34495e; overflow: hidden; }
    canvas { display: block; width: 100%; height: 100%; touch-action: none; }
    #ui { position: absolute; top: 15px; left: 15px; right: 15px; display: flex; justify-content: space-between; font-size: clamp(16px, 4vw, 24px); font-weight: bold; pointer-events: none; z-index: 2; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); }
    #equationDisplay { position: absolute; top: 60px; left: 0; right: 0; text-align: center; font-size: clamp(20px, 5vw, 36px); font-weight: bold; color: #f1c40f; pointer-events: none; z-index: 2; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); background: rgba(0,0,0,0.4); padding: 10px 0; letter-spacing: 5px;}
    #powerUpMsg { position: absolute; top: 120px; left: 50%; transform: translateX(-50%); font-size: clamp(18px, 5vw, 24px); font-weight: bold; color: #2ecc71; text-shadow: 0 0 10px #27ae60, 2px 2px 4px rgba(0,0,0,0.8); opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 2; }
    #controls { position: absolute; bottom: 30px; left: 0; right: 0; display: flex; justify-content: space-between; padding: 0 10vw; z-index: 5; pointer-events: none; }
    .control-btn { width: min(18vw, 80px); height: min(18vw, 80px); border-radius: 50%; border: 3px solid rgba(255,255,255,0.6); background: rgba(0, 0, 0, 0.4); color: white; font-size: clamp(20px, 6vw, 36px); display: flex; justify-content: center; align-items: center; pointer-events: auto; cursor: pointer; user-select: none; transition: background 0.1s; }
    .control-btn:active { background: rgba(0, 0, 0, 0.7); transform: scale(0.95); }
    #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; z-index: 10; overflow-y: auto; padding: 20px; box-sizing: border-box;}
    #overlay h1 { font-size: clamp(24px, 6vw, 40px); margin-bottom: 5px; color: #e74c3c; text-shadow: 0 0 10px rgba(231, 76, 60, 0.5); }
    #finalScore { font-size: clamp(18px, 4vw, 24px); margin-bottom: 10px; color: #ecf0f1; }
    #playerName { font-size: clamp(16px, 4vw, 22px); padding: 10px; text-align: center; border-radius: 8px; border: 2px solid #fff; outline: none; text-transform: uppercase; width: 80%; max-width: 250px; margin-bottom: 15px; font-weight: bold; background: rgba(255,255,255,0.9); color: #2c3e50;}
    #difficultyUI { margin-bottom: 15px; font-size: clamp(14px, 3.5vw, 18px); background: rgba(255,255,255,0.1); padding: 10px; border-radius: 10px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;}
    #difficultyUI label { cursor: pointer; display: flex; align-items: center; }
    #leaderboard { background: rgba(255,255,255,0.1); padding: 15px 20px; border-radius: 10px; margin-bottom: 15px; text-align: left; width: 90%; max-width: 400px; }
    #leaderboard h3 { margin: 0 0 10px 0; color: #f1c40f; text-align: center; font-size: clamp(18px, 4vw, 24px);}
    #leaderboard ol { margin: 0; padding-left: 25px; font-size: clamp(14px, 4vw, 18px); line-height: 1.5;}
    .diff-badge { font-size: 12px; background: #e74c3c; padding: 2px 6px; border-radius: 4px; margin-left: 5px; color: white;}
    .name-badge { font-weight: bold; color: #3498db; margin-right: 10px; }
    button.start { padding: 12px 40px; font-size: clamp(18px, 5vw, 24px); cursor: pointer; border: none; border-radius: 50px; background-color: #e74c3c; color: white; font-weight: bold; box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4); transition: 0.2s; margin-top: 10px;}
    button.start:hover { background-color: #c0392b; transform: scale(1.05); }
    button:disabled { background-color: #7f8c8d; cursor: not-allowed; transform: none;}
    .hidden { display: none !important; }
</style>
</head>
<body>

<div id="gameContainer">
    <div id="ui">
        <div id="timeDisplay">æ™‚é–“: 33.00s</div>
        <div id="scoreDisplay">å®Œæˆ: 0/4</div>
    </div>
    <div id="equationDisplay">_</div>
    <div id="powerUpMsg">â­â­ å…¬å¼è­·ç›¾ â­â­</div>
    <canvas id="gameCanvas"></canvas>
    <div id="controls"><div class="control-btn" id="btnLeft">â—€</div><div class="control-btn" id="btnRight">â–¶</div></div>
    
    <div id="overlay">
        <h1 id="gameOverTitle">ğŸ ç‰›é “çš„è€ƒé©— ğŸ<br>å‹»åŠ é€Ÿå…¬å¼ç‰ˆ</h1>
        <div id="finalScore" class="hidden">çµæœ</div>
        <input type="text" id="playerName" maxlength="10" placeholder="å…¥å (æœ€å¤š10å€‹è‹±æ–‡å­—)" autocomplete="off">
        <div id="leaderboard"><h3>â˜ï¸ é›²ç«¯å­¸éœ¸æ¦œ (Top 5)</h3><ol id="scoreList"><li>é€£ç·šä¸­...</li></ol></div>
        <div id="difficultyUI">
            <label><input type="radio" name="diff" value="easy"> é›£åº¦ 0</label>
            <label><input type="radio" name="diff" value="normal" checked> é›£åº¦ 9.81</label>
            <label><input type="radio" name="diff" value="hard"> é›£åº¦ 19.62</label>
            <label><input type="radio" name="diff" value="very_hard"> é›£åº¦ 29.43</label>
        </div>
        <button class="start" id="startBtn">é–‹å§‹æŒ‘æˆ°</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    // ğŸ”´ ğŸ”´ ğŸ”´ è«‹å°‡å‘¢æ®µæ›è¿”åšä½ è‡ªå·±å˜… Firebase Config ğŸ”´ ğŸ”´ ğŸ”´
    const firebaseConfig = {
      apiKey: "AIzaSyDoHHh-8Gm5tt_uWF4IPGIGfOTNYnAgHr4",
      authDomain: "physicsgame-rl.firebaseapp.com",
      projectId: "physicsgame-rl",
      storageBucket: "physicsgame-rl.firebasestorage.app",
      messagingSenderId: "68402923149",
      appId: "1:68402923149:web:0bb2be531b9e971a6544c4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const canvas = document.getElementById('gameCanvas'); const ctx = canvas.getContext('2d');
    const timeDisplay = document.getElementById('timeDisplay'); const scoreDisplay = document.getElementById('scoreDisplay');
    const equationDisplay = document.getElementById('equationDisplay'); const powerUpMsg = document.getElementById('powerUpMsg');
    const overlay = document.getElementById('overlay'); const startBtn = document.getElementById('startBtn');
    const gameOverTitle = document.getElementById('gameOverTitle'); const finalScore = document.getElementById('finalScore');
    const scoreList = document.getElementById('scoreList'); const difficultyRadios = document.getElementsByName('diff');
    const playerNameInput = document.getElementById('playerName');

    function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resizeCanvas); resizeCanvas();

    playerNameInput.addEventListener('input', function() { this.value = this.value.replace(/[^A-Za-z]/g, '').toUpperCase(); });

    const formulas = [
        ['v', '=', 'u', '+', 'a', 't'],
        ['s', '=', 'Â½', '(', 'u', '+', 'v', ')', 't'],
        ['s', '=', 'u', 't', '+', 'Â½', 'a', 't', 'Â²'],
        ['v', 'Â²', '=', 'u', 'Â²', '+', '2', 'a', 's']
    ];
    
    const allValidSymbols = ['s', 'u', 'v', 'a', 't', '=', '+', '(', ')', 'Â²', 'Â½', '2'];
    const trapSymbols = ['4', '-', 'Â¼', 'âˆš'];

    let isPlaying = false, startTime = 0, totalBonusTime = 0, currentDisplayTime = 33.00;
    let animationId, currentDiff = 'normal', isInvincible = false, invincibleTimer = null; 
    let currentPlayerName = "STUDENT";
    let completedFormulas = [], currentInput = [];

    // ğŸŒŸ æå‡äº†ã€Œç›®æ¨™ç¬¦è™Ÿ (rates[0])ã€çš„å‡ºç¾æ©Ÿç‡
    const diffSettings = {
        'easy': { name: '0', speedBase: 0.003, rates: [0.60, 0.37, 0.00, 0.03, 0.00], starTime: 0 },
        'normal': { name: '9.81', speedBase: 0.005, rates: [0.55, 0.42, 0.00, 0.03, 0.00], starTime: 0 },
        'hard': { name: '19.62', speedBase: 0.007, rates: [0.50, 0.30, 0.18, 0.01, 0.01], starTime: 5000 },
        'very_hard': { name: '29.43', speedBase: 0.009, rates: [0.45, 0.25, 0.28, 0.01, 0.01], starTime: 3000 }
    };

    const keys = { ArrowLeft: false, ArrowRight: false };
    window.addEventListener('keydown', (e) => { if (keys.hasOwnProperty(e.code)) { keys[e.code] = true; e.preventDefault(); } });
    window.addEventListener('keyup', (e) => { if (keys.hasOwnProperty(e.code)) keys[e.code] = false; });
    const btnLeft = document.getElementById('btnLeft'); const btnRight = document.getElementById('btnRight');
    const pressLeft = (e) => { e.preventDefault(); keys.ArrowLeft = true; }; const releaseLeft = (e) => { e.preventDefault(); keys.ArrowLeft = false; };
    const pressRight = (e) => { e.preventDefault(); keys.ArrowRight = true; }; const releaseRight = (e) => { e.preventDefault(); keys.ArrowRight = false; };
    btnLeft.addEventListener('touchstart', pressLeft, {passive: false}); btnLeft.addEventListener('touchend', releaseLeft); btnLeft.addEventListener('mousedown', pressLeft); btnLeft.addEventListener('mouseup', releaseLeft); btnLeft.addEventListener('mouseleave', releaseLeft);
    btnRight.addEventListener('touchstart', pressRight, {passive: false}); btnRight.addEventListener('touchend', releaseRight); btnRight.addEventListener('mousedown', pressRight); btnRight.addEventListener('mouseup', releaseRight); btnRight.addEventListener('mouseleave', releaseRight);

    let player = { emoji: 'ğŸ', x: canvas.width / 2 };
    let fallingObjects = [];

    const AudioContext = window.AudioContext || window.webkitAudioContext; let audioCtx;
    function playSound(type) {
        if (!audioCtx) return; const osc = audioCtx.createOscillator(); const gainNode = audioCtx.createGain(); osc.connect(gainNode); gainNode.connect(audioCtx.destination);
        if(type === 'catch') { osc.type = 'sine'; osc.frequency.setValueAtTime(800, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1); gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime); gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1); osc.start(); osc.stop(audioCtx.currentTime + 0.1); }
        else if(type === 'error') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.2); gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime); gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2); osc.start(); osc.stop(audioCtx.currentTime + 0.2); }
        else if(type === 'success') { osc.type = 'square'; osc.frequency.setValueAtTime(400, audioCtx.currentTime); osc.frequency.linearRampToValueAtTime(600, audioCtx.currentTime + 0.1); osc.frequency.linearRampToValueAtTime(1000, audioCtx.currentTime + 0.3); gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime); gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4); osc.start(); osc.stop(audioCtx.currentTime + 0.4); }
    }

    async function renderLeaderboard() {
        try {
            const q = query(collection(db, "physics_leaderboard"), orderBy("compositeScore", "desc"), limit(5));
            const querySnapshot = await getDocs(q);
            scoreList.innerHTML = '';
            if (querySnapshot.empty) { scoreList.innerHTML = '<li>æš«ç„¡ç´€éŒ„ï¼Œæˆç‚ºé¦–ä½å­¸éœ¸å•¦ï¼</li>'; return; }
            querySnapshot.forEach((doc) => {
                const s = doc.data();
                const li = document.createElement('li');
                let resultText = s.completed === 4 ? `å®Œæˆ 4 æ¢ (è€—æ™‚ ${s.timeUsed}s)` : `å®Œæˆ ${s.completed} æ¢`;
                li.innerHTML = `<span class="name-badge">${s.name}</span>${resultText} <span class="diff-badge">é›£åº¦ ${s.difficulty}</span>`;
                scoreList.appendChild(li);
            });
        } catch (error) { console.error("Error reading leaderboard:", error); scoreList.innerHTML = '<li>è®€å–å¤±æ•—</li>'; }
    }
    renderLeaderboard();

    async function saveScoreToCloud(completed, timeUsed, diffName, pName) {
        try {
            let timeMs = Math.floor(parseFloat(timeUsed) * 100);
            let compositeScore = (completed * 100000);
            if (completed === 4) compositeScore += (100000 - timeMs); 
            await addDoc(collection(db, "physics_leaderboard"), { name: pName, completed: completed, timeUsed: timeUsed, compositeScore: compositeScore, difficulty: diffName, timestamp: new Date() });
        } catch (error) { console.error("Error saving score:", error); }
    }

    function getValidTargets() {
        if (currentInput.length === 0) {
            let valid = new Set();
            formulas.forEach((f, i) => { if (!completedFormulas.includes(i)) valid.add(f[0]); });
            return Array.from(valid);
        }
        let valid = new Set();
        formulas.forEach((f, i) => {
            if (completedFormulas.includes(i)) return;
            let match = true;
            for (let j=0; j<currentInput.length; j++) { if (f[j] !== currentInput[j]) { match = false; break; } }
            if (match && f.length > currentInput.length) valid.add(f[currentInput.length]);
        });
        return Array.from(valid);
    }

    function spawnObject() {
        if (!isPlaying) return;
        
        let objSize = Math.max(30, Math.min(60, canvas.width * 0.08));
        const settings = diffSettings[currentDiff];
        const r = Math.random();
        
        let symbol = ''; let type = 'symbol'; 
        let targetProb = settings.rates[0]; let validProb = settings.rates[1]; let trapProb = settings.rates[2]; let clockProb = settings.rates[3];
        let validTargets = getValidTargets();
        
        // ç´€éŒ„å‘¢ä¸€ç²’ä¿‚å’ªã€Œæ€¥éœ€ç›®æ¨™ç¬¦è™Ÿã€
        let isTarget = false;

        if (r < clockProb) { symbol = 'â°'; type = 'clock'; }
        else if (r < clockProb + settings.rates[4]) { symbol = 'â­'; type = 'star'; }
        else if (r < clockProb + settings.rates[4] + trapProb) { symbol = trapSymbols[Math.floor(Math.random() * trapSymbols.length)]; type = 'trap'; }
        else if (r < clockProb + settings.rates[4] + trapProb + targetProb && validTargets.length > 0) { 
            symbol = validTargets[Math.floor(Math.random() * validTargets.length)]; 
            isTarget = true; // æ¨™è¨˜ç‚ºç›®æ¨™ç¬¦è™Ÿ
        }
        else { symbol = allValidSymbols[Math.floor(Math.random() * allValidSymbols.length)]; }

        // ğŸŒŸ é˜²é‡ç–Šæ©Ÿåˆ¶ + æ™ºèƒ½è¿½è¹¤ (Proximity Spawn) ğŸŒŸ
        let newX;
        let overlap = true;
        let attempts = 0;
        
        while (overlap && attempts < 10) {
            if (isTarget) {
                // å¦‚æœä¿‚ç›®æ¨™ç¬¦è™Ÿï¼Œå¼·åˆ¶å–ºè˜‹æœé™„è¿‘ (å·¦å³ 30% ç•«é¢é—Šåº¦å…§) é™è½ï¼
                let minX = Math.max(objSize, player.x - canvas.width * 0.3);
                let maxX = Math.min(canvas.width - objSize, player.x + canvas.width * 0.3);
                newX = minX + Math.random() * (maxX - minX);
            } else {
                // å¦å‰‡å…¨ç•«é¢éš¨æ©Ÿé™è½
                newX = objSize + Math.random() * (canvas.width - objSize * 2);
            }
            
            overlap = false;
            for (let i = 0; i < fallingObjects.length; i++) {
                let existingObj = fallingObjects[i];
                if (existingObj.y < objSize * 2.5 && Math.abs(existingObj.x - newX) < objSize * 1.5) {
                    overlap = true;
                    break;
                }
            }
            attempts++;
        }
        
        if (overlap) return; 

        let speed = canvas.height * settings.speedBase * (0.8 + Math.random() * 0.4);
        fallingObjects.push({ symbol: symbol, type: type, x: newX, y: -objSize, size: objSize, speed: speed });
    }

    function activateStar() { playSound('success'); isInvincible = true; powerUpMsg.innerText = "â­â­ å…¬å¼è­·ç›¾ â­â­"; powerUpMsg.style.opacity = "1"; if (invincibleTimer) clearTimeout(invincibleTimer); invincibleTimer = setTimeout(() => { isInvincible = false; powerUpMsg.style.opacity = "0"; }, diffSettings[currentDiff].starTime); }
    
    // ğŸŒŸ æ™‚é˜å¢åŠ æ”¹ç‚º +4 ç§’
    function activateClock() { 
        playSound('success'); totalBonusTime += 4; 
        powerUpMsg.innerText = "â° æ™‚é–“ +4 ç§’ â°"; powerUpMsg.style.opacity = "1"; 
        setTimeout(() => { if(!isInvincible) powerUpMsg.style.opacity = "0"; }, 1500); 
    }

    function drawBlock(obj) {
        ctx.font = `bold ${obj.size * 0.7}px Arial`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        if (obj.type === 'clock' || obj.type === 'star' || obj.symbol === 'ğŸ' || obj.symbol === 'ğŸ‰' || obj.symbol === 'ğŸ’¯') { ctx.fillText(obj.symbol, obj.x, obj.y); return; }

        let bgColor = '#ecf0f1'; let textColor = '#2c3e50';
        if (obj.type === 'trap') { bgColor = '#e74c3c'; textColor = 'white'; }
        
        ctx.fillStyle = bgColor; ctx.beginPath(); ctx.roundRect(obj.x - obj.size/2, obj.y - obj.size/2, obj.size, obj.size, 8); ctx.fill();
        ctx.fillStyle = textColor; ctx.fillText(obj.symbol, obj.x, obj.y);
    }

    function updateEquationDisplay() {
        if (currentInput.length === 0) equationDisplay.innerText = "è«‹æ¥å–å…¬å¼èµ·å§‹ç¬¦è™Ÿ...";
        else equationDisplay.innerText = currentInput.join(" ") + " _";
    }

    function update() {
        if (!isPlaying) return; ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        let now = Date.now(); let elapsed = (now - startTime) / 1000;
        // ğŸŒŸ è¨ˆç®—é¡¯ç¤ºæ™‚é–“ï¼Œç”± 33 ç§’é–‹å§‹
        currentDisplayTime = Math.max(0, 33.00 + totalBonusTime - elapsed);
        timeDisplay.innerText = `æ™‚é–“: ${currentDisplayTime.toFixed(2)}s`;

        if (currentDisplayTime <= 0) { endGame(); return; }

        player.size = Math.max(50, Math.min(100, canvas.width * 0.12)); player.y = canvas.height - player.size;
        let pSpeed = canvas.width * 0.015;

        if (keys.ArrowLeft && player.x > player.size / 2) player.x -= pSpeed; 
        if (keys.ArrowRight && player.x < canvas.width - player.size / 2) player.x += pSpeed;
        
        if (isInvincible) { ctx.shadowColor = "#f1c40f"; ctx.shadowBlur = 30; } else { ctx.shadowBlur = 0; }
        drawBlock({symbol: player.emoji, x: player.x, y: player.y, size: player.size}); ctx.shadowBlur = 0; 

        let validTargets = getValidTargets();

        for (let i = fallingObjects.length - 1; i >= 0; i--) {
            let obj = fallingObjects[i]; obj.y += obj.speed;
            if (obj.type === 'star' || obj.type === 'clock') { ctx.shadowColor = "white"; ctx.shadowBlur = 15; }
            drawBlock(obj); ctx.shadowBlur = 0;

            const dx = player.x - obj.x; const dy = player.y - obj.y;
            if (Math.sqrt(dx * dx + dy * dy) < (player.size/2 + obj.size/2 - 10)) { 
                
                if (obj.type === 'star') activateStar(); 
                else if (obj.type === 'clock') activateClock(); 
                else {
                    if (validTargets.includes(obj.symbol)) {
                        playSound('catch'); currentInput.push(obj.symbol);
                        formulas.forEach((f, idx) => {
                            if (!completedFormulas.includes(idx) && currentInput.join('') === f.join('')) {
                                completedFormulas.push(idx); currentInput = []; 
                                scoreDisplay.innerText = `å®Œæˆ: ${completedFormulas.length}/4`; playSound('success');
                                fallingObjects.push({symbol: 'ğŸ’¯', type: 'reward', x: player.x, y: player.y - 50, size: 80, speed: -2});
                            }
                        });
                        updateEquationDisplay();
                        if (completedFormulas.length === 4) { endGame(true); return; } 
                    } else {
                        if (!isInvincible) {
                            playSound('error'); currentInput = []; updateEquationDisplay();
                            equationDisplay.style.color = '#e74c3c'; setTimeout(()=> equationDisplay.style.color = '#f1c40f', 300);
                        }
                    }
                }
                fallingObjects.splice(i, 1); continue;
            }
            if (obj.y > canvas.height + obj.size || obj.y < -100) fallingObjects.splice(i, 1); 
        }
        
        // ğŸŒŸ æ¸›å°‘äº†æ•´é«”æ‰è½æ©Ÿç‡ (~30%)ï¼Œä»¤ç•«é¢ä¹¾æ·¨
        let spawnRate = 0.018; 
        if (currentDiff === 'hard') spawnRate = 0.025; 
        if (currentDiff === 'very_hard') spawnRate = 0.032; 
        
        if (Math.random() < spawnRate) spawnObject();
        
        animationId = requestAnimationFrame(update);
    }

    function startGame() {
        currentPlayerName = playerNameInput.value.trim().toUpperCase() || "STUDENT";
        for(let radio of difficultyRadios) { if(radio.checked) currentDiff = radio.value; }

        completedFormulas = []; currentInput = []; fallingObjects = []; 
        totalBonusTime = 0; startTime = Date.now(); currentDisplayTime = 33.00; // é‡ç½®ç‚º 33 ç§’
        player.x = canvas.width / 2; isPlaying = true; isInvincible = false; powerUpMsg.style.opacity = "0";
        if(invincibleTimer) clearTimeout(invincibleTimer);
        
        scoreDisplay.innerText = `å®Œæˆ: 0/4`; updateEquationDisplay();
        timeDisplay.innerText = `æ™‚é–“: 33.00s`; // åˆå§‹ UI æ›´æ–°
        overlay.classList.add('hidden'); 

        if (!audioCtx) audioCtx = new AudioContext(); if (audioCtx.state === 'suspended') audioCtx.resume();
        resizeCanvas(); update();
    }

    async function endGame(allCompleted = false) {
        isPlaying = false; cancelAnimationFrame(animationId);
        
        startBtn.innerText = "ä¸Šå‚³æˆç¸¾ä¸­..."; startBtn.disabled = true;

        // ğŸŒŸ çµç®—æ™‚é–“åŒæ¨£åŸºæ–¼ 33 ç§’è¨ˆç®—
        let finalTimeUsed = allCompleted ? (33.00 + totalBonusTime - currentDisplayTime).toFixed(2) : "33.00";
        await saveScoreToCloud(completedFormulas.length, finalTimeUsed, diffSettings[currentDiff].name, currentPlayerName);
        await renderLeaderboard();

        gameOverTitle.innerHTML = allCompleted ? "ğŸ† å­¸éœ¸èª•ç”Ÿï¼ğŸ†" : "æ™‚é™åˆ°ï¼å†æ¥å†å²";
        finalScore.innerText = allCompleted ? `å…¨éƒ¨å®Œæˆï¼è€—æ™‚ï¼š${finalTimeUsed} ç§’` : `æˆåŠŸå®Œæˆï¼š${completedFormulas.length} æ¢å…¬å¼`;
        finalScore.classList.remove('hidden');
        
        startBtn.innerText = "å†æ¬¡æŒ‘æˆ°"; startBtn.disabled = false;
        document.getElementById('difficultyUI').classList.remove('hidden');
        powerUpMsg.style.opacity = "0"; 
        
        keys.ArrowLeft = false; keys.ArrowRight = false; overlay.classList.remove('hidden');
    }

    startBtn.addEventListener('click', startGame);
</script>
</body>
</html>
