<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>è˜‹æœçš„è€ƒé©— V0.6.1</title>
<style>
    :root { --accent: #e74c3c; --gold: #f1c40f; }
    body { margin: 0; padding: 0; background-color: #121212; display: flex; justify-content: center; align-items: center; height: 100vh; height: 100dvh; font-family: 'Segoe UI', Arial, sans-serif; overflow: hidden; color: white; }
    #gameContainer { position: relative; width: 100vw; height: 100vh; background-color: #1a1a1a; overflow: hidden; }
    canvas { display: block; width: 100%; height: 100%; touch-action: none; }
    
    /* UI é ‚éƒ¨ */
    #ui { position: absolute; top: 10px; left: 15px; right: 15px; display: flex; justify-content: space-between; font-size: clamp(12px, 3vw, 16px); font-weight: bold; pointer-events: none; z-index: 5; text-shadow: 2px 2px 4px black; }
    #equationHeader { position: absolute; top: 40px; left: 0; right: 0; text-align: center; z-index: 5; pointer-events: none; }
    #targetEquation { font-size: clamp(16px, 5vw, 32px); font-weight: bold; color: var(--gold); background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 15px; display: inline-block; min-width: 85%; border: 1px solid rgba(255,255,255,0.1); }
    .next-char { color: #fff; text-decoration: underline; text-underline-offset: 6px; animation: blink 0.8s infinite; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

    /* Overlay åŸºç¤ */
    .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.96); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; z-index: 20; padding: 20px; box-sizing: border-box; overflow-y: auto; transition: 0.3s; }
    .hidden { display: none !important; }

    /* æ–‡å­—æ¨£å¼ */
    h1 { color: var(--accent); font-size: clamp(30px, 8vw, 48px); margin: 10px 0; text-shadow: 0 0 15px rgba(231,76,60,0.3); }
    .quote-text { font-size: clamp(18px, 4vw, 24px); line-height: 2; letter-spacing: 3px; color: var(--gold); animation: fadeIn 2s; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

    /* æŒ‰éˆ• */
    .btn-apple { padding: 12px 35px; font-size: 18px; cursor: pointer; border: none; border-radius: 50px; background: var(--accent); color: white; font-weight: bold; margin: 10px; transition: 0.2s; box-shadow: 0 4px 15px rgba(231,76,60,0.3); }
    .btn-apple:hover { transform: scale(1.05); filter: brightness(1.1); }
    .btn-detail { background: #34495e; font-size: 14px; padding: 8px 20px; }

    /* è¦å‰‡ç›’ */
    #detailRulesBox { background: rgba(255,255,255,0.05); border: 1px solid var(--gold); padding: 20px; border-radius: 15px; text-align: left; max-width: 400px; font-size: 14px; line-height: 1.8; }

    /* æ§åˆ¶å™¨ */
    #controls { position: absolute; bottom: 20px; left: 0; right: 0; display: flex; justify-content: center; gap: 8px; z-index: 10; pointer-events: none; }
    .control-btn { width: 65px; height: 65px; border-radius: 12px; background: rgba(0,0,0,0.6); color: white; font-size: 22px; display: flex; justify-content: center; align-items: center; pointer-events: auto; cursor: pointer; border: 1px solid rgba(255,255,255,0.2); }

    /* è¡¨æ ¼ */
    table { width: 100%; max-width: 300px; margin: 20px 0; border-collapse: collapse; background: rgba(255,255,255,0.03); }
    td { padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); }

    #countdownOverlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); font-size: 80px; font-weight: bold; color: var(--accent); z-index: 40; pointer-events: none; }
</style>
</head>
<body>

<div id="gameContainer">
    <div id="ui">
        <div id="levelDisplay">é—œå¡: 1/4</div>
        <div id="timeDisplay">æ™‚é–“: 9.81s</div>
        <div id="versionTag">V0.6.1</div>
    </div>
    
    <div id="equationHeader"><div id="targetEquation">è˜‹æœçš„è€ƒé©—</div></div>
    <div id="countdownOverlay" class="hidden"></div>
    <canvas id="gameCanvas"></canvas>
    
    <div id="controls">
        <div class="control-btn" id="btnFastLeft">â—€â—€</div>
        <div class="control-btn" id="btnLeft">â—€</div>
        <div class="control-btn" id="btnRight">â–¶</div>
        <div class="control-btn" id="btnFastRight">â–¶â–¶</div>
    </div>

    <div id="mainMenu" class="overlay">
        <h1>ğŸ è˜‹æœçš„è€ƒé©—</h1>
        <p style="opacity:0.8">ä¾åºæ¥å–æ­£ç¢ºç¬¦è™Ÿï¼ŒæŒ‘æˆ°æœ€çŸ­ç‰©ç†å…¬å¼èƒŒèª¦æ™‚é–“ï¼</p>
        
        <div style="margin: 15px 0;">
            <input type="text" id="playerName" maxlength="12" placeholder="è¼¸å…¥å­¸éœ¸åå­—" style="font-size: 18px; padding: 10px; border-radius: 8px; text-align: center; border: none;">
        </div>

        <div id="difficultyUI" style="margin-bottom: 20px;">
            <label><input type="radio" name="diff" value="0" checked> é›£åº¦ 0</label>
            <label style="margin-left:10px;"><input type="radio" name="diff" value="9.81"> é›£åº¦ 9.81</label>
            <label style="margin-left:10px;"><input type="radio" name="diff" value="19.62"> é›£åº¦ 19.62</label>
            <label style="margin-left:10px;"><input type="radio" name="diff" value="29.43"> é›£åº¦ 29.43</label>
        </div>

        <div style="margin-bottom: 20px;">
            è²æ•ˆï¼š<button id="soundToggle" class="btn-apple btn-detail" style="margin:0">é–‹å•Ÿ ON</button>
        </div>

        <button class="btn-apple" id="startChallengeBtn">é–‹å§‹æŒ‘æˆ°</button>
        <button class="btn-apple btn-detail" id="openRulesBtn">è©³ç´°è¦å‰‡èªªæ˜</button>
    </div>

    <div id="rulesOverlay" class="overlay hidden">
        <h2 style="color:var(--gold)">ğŸ“œ è©³ç´°è¦å‰‡</h2>
        <div id="detailRulesBox">
            â€¢ <b>ç›®æ¨™</b>ï¼šä¾ç•«é¢ä¸Šæ–¹é»ƒè‰²å…¬å¼é †åºï¼Œæ§åˆ¶è˜‹æœæ¥ä½å­—å…ƒã€‚<br>
            â€¢ <b>æ™‚é–“æ©Ÿåˆ¶</b>ï¼šæ¯é—œç”± 9.81s é–‹å§‹å€’æ•¸ã€‚<br>
            â€¢ <b>çå‹µ</b>ï¼šæ¥ä¸­æ­£ç¢ºå­—å…ƒ +0.5sï¼Œæ¥ä¸­æ™‚é˜ (â°) +3sã€‚<br>
            â€¢ <b>æ‡²ç½°</b>ï¼šé›£åº¦ 0-9 æ‰£æ™‚é–“ï¼›é›£åº¦ 19.62+ å‰‡å…¬å¼é‡ç½®ã€‚<br>
            â€¢ <b>æ“ä½œ</b>ï¼šé›»è…¦ç”¨ç®­é ­å¾®èª¿ï¼ŒShift åŠ é€Ÿï¼›æ‰‹æ©Ÿç”¨ä¸‹æ–¹æŒ‰éˆ•ã€‚
        </div>
        <button class="btn-apple btn-detail" id="closeRulesBtn">è¿”å›ä¸»é </button>
    </div>

    <div id="levelClearOverlay" class="overlay hidden">
        <h2 id="stageTitle" style="color:var(--gold)">ç¬¬ 1 é—œ å®Œæˆï¼</h2>
        <p id="stageTimeText"></p>
        <button class="btn-apple" id="nextLevelBtn">é€²å…¥ä¸‹ä¸€é—œ</button>
    </div>

    <div id="finalOverlay" class="overlay hidden">
        <h1>ğŸ† æŒ‘æˆ°å®Œæˆ</h1>
        <table id="finalStatsTable"></table>
        <h2 id="finalTotalScore" style="color:var(--gold)"></h2>
        <div style="width: 100%; max-width: 400px; background: rgba(255,255,255,0.05); border-radius: 10px; padding: 10px; margin-top: 10px;">
            <h3 style="margin:5px">â˜ï¸ é›²ç«¯å­¸éœ¸æ¦œ (Top 5)</h3>
            <ol id="leaderboardList" style="text-align:left; font-size:14px;"></ol>
        </div>
        <button class="btn-apple" id="backToHomeBtn">è¿”å›ä¸»é </button>
    </div>

    <div id="quoteOverlay" class="overlay hidden">
        <div class="quote-text">
            ã€Œç ”ç¿’ç‰©ç†ï¼Œéœ€å¿ƒç„¡æ—é¶©ã€‚ã€<br><br>
            ã€Œå¬‰æˆ²ä¹‹æ™‚ï¼Œè«å¿˜æ¢ç´¢çœŸç†ã€‚ã€
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    // ğŸ”´ è«‹æ›´æ›ç‚ºä½ çš„ Firebase Config ğŸ”´
    const firebaseConfig = {
      apiKey: "AIzaSyDoHHh-8Gm5tt_uWF4IPGIGfOTNYnAgHr4",
      authDomain: "physicsgame-rl.firebaseapp.com",
      projectId: "physicsgame-rl",
      storageBucket: "physicsgame-rl.firebasestorage.app",
      messagingSenderId: "68402923149",
      appId: "1:68402923149:web:0bb2be531b9e971a6544c4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const formulas = [['v', '=', 'u', '+', 'a', 't'], ['s', '=', 'Â½', '(', 'u', '+', 'v', ')', 't'], ['s', '=', 'u', 't', '+', 'Â½', 'a', 't', 'Â²'], ['v', 'Â²', '=', 'u', 'Â²', '+', '2', 'a', 's']];
    const distMap = { 'v': ['u', 'y'], 'u': ['v', 'w'], 's': ['d', 'h'], 'a': ['g', 'q'], 't': ['f', 'x'], '=': ['â‰ˆ'], '+': ['-'], '(': ['['], ')': [']'], 'Â²': ['Â³'], 'Â½': ['â…“'], '2': ['3'] };

    let isPlaying = false, currentLevel = 0, currentCharIdx = 0, startTime = 0, timeBonus = 0;
    let levelTimes = [0, 0, 0, 0], objects = [], combo = 0, soundEnabled = true, currentDiff = 0;
    const player = { x: 0, y: 0, size: 65, color: '#e74c3c' };
    const controlState = { left: false, right: false, fastLeft: false, fastRight: false };

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; player.x = canvas.width/2; player.y = canvas.height - 100; }
    window.addEventListener('resize', resize); resize();

    // è²æ•ˆå¼•æ“
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playBeep(freq, dur) {
        if (!soundEnabled) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + dur);
    }

    // æ§åˆ¶å™¨ç¶å®š
    const bindBtn = (id, key) => {
        const el = document.getElementById(id);
        el.onmousedown = el.ontouchstart = (e) => { e.preventDefault(); controlState[key] = true; };
        el.onmouseup = el.onmouseleave = el.ontouchend = () => controlState[key] = false;
    };
    bindBtn('btnFastLeft', 'fastLeft'); bindBtn('btnLeft', 'left'); bindBtn('btnRight', 'right'); bindBtn('btnFastRight', 'fastRight');
    window.onkeydown = (e) => { if(e.key==='ArrowLeft') { if(e.shiftKey) controlState.fastLeft=true; else controlState.left=true; } if(e.key==='ArrowRight') { if(e.shiftKey) controlState.fastRight=true; else controlState.right=true; } };
    window.onkeyup = () => Object.keys(controlState).forEach(k => controlState[k] = false);

    // ä»‹é¢åˆ‡æ›é‚è¼¯
    const showOverlay = (id) => { document.querySelectorAll('.overlay').forEach(o => o.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); };
    document.getElementById('openRulesBtn').onclick = () => showOverlay('rulesOverlay');
    document.getElementById('closeRulesBtn').onclick = () => showOverlay('mainMenu');
    document.getElementById('soundToggle').onclick = function() { soundEnabled = !soundEnabled; this.innerText = soundEnabled ? "é–‹å•Ÿ ON" : "é—œé–‰ OFF"; };
    document.getElementById('startChallengeBtn').onclick = () => {
        currentDiff = parseFloat(document.querySelector('input[name="diff"]:checked').value);
        levelTimes = [0,0,0,0];
        showOverlay('hidden'); // éš±è—æ‰€æœ‰
        startLevelFlow(0);
    };

    async function startLevelFlow(idx) {
        isPlaying = false;
        currentLevel = idx; currentCharIdx = 0; timeBonus = 0; combo = 0;
        objects = []; // ğŸŒŸ çœŸç©ºæ¸…ç†ï¼šç¢ºä¿èˆŠç‰©æ¶ˆå¤±
        
        document.getElementById('levelDisplay').innerText = `é—œå¡: ${currentLevel + 1}/4`;
        updateFormulaUI();

        // å„€å¼æ„Ÿå€’æ•¸
        const countdown = document.getElementById('countdownOverlay');
        countdown.classList.remove('hidden');
        const steps = [`ç¬¬ ${currentLevel+1} é—œ`, "READY?", "3", "2", "1", "GO!"];
        for (let s of steps) {
            countdown.innerText = s;
            playBeep(s === "GO!" ? 800 : 400, 0.1);
            await new Promise(r => setTimeout(r, 650));
        }
        countdown.classList.add('hidden');
        
        startTime = Date.now();
        isPlaying = true;
        gameLoop();
    }

    function updateFormulaUI() {
        const f = formulas[currentLevel];
        let h = "";
        f.forEach((c, i) => {
            if (i < currentCharIdx) h += `<span style="color:#2ecc71">${c}</span>`;
            else if (i === currentCharIdx) h += `<span class="next-char">${c}</span>`;
            else h += `<span style="opacity:0.2">${c}</span>`;
        });
        document.getElementById('targetEquation').innerHTML = h;
    }

    function spawn(forceCorrect = false) {
        const f = formulas[currentLevel], target = f[currentCharIdx];
        let char = '', type = 'dist';
        const speeds = { '0':0.0035, '9.81':0.0055, '19.62':0.0075, '29.43':0.01 };
        
        if (forceCorrect || Math.random() < 0.7) {
            if (Math.random() > 0.6 && currentCharIdx + 1 < f.length) char = f[currentCharIdx+1];
            else char = target;
            type = 'correct';
        } else if (Math.random() < 0.05) { char = 'â°'; type = 'clock'; }
        else {
            const sims = distMap[target] || ['X'];
            char = sims[Math.floor(Math.random()*sims.length)];
        }
        objects.push({ char, type, x: Math.random()*(canvas.width-60)+30, y: -50, speed: canvas.height * speeds[currentDiff] * (0.9 + Math.random()*0.3) });
    }

    function gameLoop() {
        if (!isPlaying) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const now = Date.now();
        const remain = Math.max(0, 9.81 + timeBonus - (now - startTime)/1000);
        document.getElementById('timeDisplay').innerText = `æ™‚é–“: ${remain.toFixed(2)}s`;

        if (remain <= 0) {
            isPlaying = false;
            levelTimes[currentLevel] += (Date.now() - startTime) / 1000;
            alert("æ™‚é–“åˆ°ï¼è©²é—œç´¯è¨ˆè¨ˆæ™‚é‡ä¾†ã€‚");
            startLevelFlow(currentLevel);
            return;
        }

        // ç§»å‹•é‚è¼¯
        const micro = canvas.width * 0.006, fast = canvas.width * 0.035;
        if (controlState.fastLeft) player.x -= fast; else if (controlState.left) player.x -= micro;
        if (controlState.fastRight) player.x += fast; else if (controlState.right) player.x += micro;
        player.x = Math.max(35, Math.min(canvas.width - 35, player.x));

        // ç•«è˜‹æœ (é‡‘è‰²ç‰¹æ•ˆ)
        ctx.font = "65px Arial"; ctx.textAlign = "center";
        if (combo > 5) { ctx.shadowBlur = 20; ctx.shadowColor = varGold(); }
        ctx.fillText("ğŸ", player.x, player.y);
        ctx.shadowBlur = 0;

        for (let i = objects.length - 1; i >= 0; i--) {
            const o = objects[i]; o.y += o.speed;
            if (o.y > canvas.height + 50) { objects.splice(i, 1); continue; }
            ctx.font = "bold 40px Arial";
            ctx.fillStyle = (o.char === formulas[currentLevel][currentCharIdx]) ? varGold() : "white";
            ctx.fillText(o.char, o.x, o.y);

            if (Math.abs(player.x - o.x) < 45 && Math.abs(player.y - o.y) < 45) {
                handleCatch(o); objects.splice(i, 1);
            }
        }
        if (Math.random() < 0.05) spawn();
        requestAnimationFrame(gameLoop);
    }

    function handleCatch(o) {
        if (o.char === 'â°') { timeBonus += 3; playBeep(600, 0.2); return; }
        if (o.char === formulas[currentLevel][currentCharIdx]) {
            currentCharIdx++; combo++;
            let b = 0.5 + (Math.min(combo, 10) * 0.05);
            timeBonus += b;
            playBeep(combo > 5 ? 1200 : 800, 0.1); // é‡‘è‰²è˜‹æœè²æ•ˆ
            spawn(true); // æ¥ä¸­å³ç”¢ä¸‹ä¸€å€‹
            if (currentCharIdx >= formulas[currentLevel].length) {
                isPlaying = false;
                levelTimes[currentLevel] += (Date.now() - startTime) / 1000;
                objects = []; // ğŸŒŸ æ¸…ç†
                showLevelClear();
            } else updateFormulaUI();
        } else {
            combo = 0; playBeep(200, 0.3);
            if (currentDiff >= 19.62) { currentCharIdx = 0; updateFormulaUI(); }
            else timeBonus -= (currentDiff === 0 ? 1.5 : 3.0);
        }
    }

    function varGold() { return getComputedStyle(document.documentElement).getPropertyValue('--gold').trim(); }

    function showLevelClear() {
        const overlay = document.getElementById('levelClearOverlay');
        document.getElementById('stageTitle').innerText = `ç¬¬ ${currentLevel+1} é—œ å®Œæˆï¼`;
        document.getElementById('stageTimeText').innerText = `æœ¬é—œç´¯ç©è€—æ™‚ï¼š${levelTimes[currentLevel].toFixed(2)}s`;
        overlay.classList.remove('hidden');
        document.getElementById('nextLevelBtn').onclick = () => {
            overlay.classList.add('hidden');
            if (currentLevel < 3) startLevelFlow(currentLevel + 1);
            else showFinalResult();
        };
    }

    async function showFinalResult() {
        showOverlay('finalOverlay');
        const table = document.getElementById('finalStatsTable');
        table.innerHTML = ""; let total = 0;
        levelTimes.forEach((t, i) => { total += t; table.innerHTML += `<tr><td>é—œå¡ ${i+1}</td><td>${t.toFixed(2)}s</td></tr>`; });
        document.getElementById('finalTotalScore').innerText = `ç¸½æˆç¸¾ï¼š${total.toFixed(2)}s`;
        
        // ä¿®æ­£ undefined bug
        const name = document.getElementById('playerName').value.trim().toUpperCase() || "ANONYMOUS";
        const score = 1000000 - Math.floor(total * 100);
        try {
            await addDoc(collection(db, "physics_leaderboard"), { name, totalTime: total.toFixed(2), difficulty: currentDiff, compositeScore: score, timestamp: new Date() });
            renderLeaderboard();
        } catch(e) {}
    }

    async function renderLeaderboard() {
        const list = document.getElementById('leaderboardList'); list.innerHTML = '<li>è¼‰å…¥ä¸­...</li>';
        const q = query(collection(db, "physics_leaderboard"), orderBy("compositeScore", "desc"), limit(5));
        const snap = await getDocs(q);
        list.innerHTML = '';
        snap.forEach(doc => {
            const d = doc.data();
            // ğŸŒŸ ä¿®æ­£æ¬„ä½åç¨±å°é½Šï¼šä½¿ç”¨ totalTime
            list.innerHTML += `<li><b>${d.name}</b>: ${d.totalTime}s (é›£åº¦ ${d.difficulty || 0})</li>`;
        });
    }

    document.getElementById('backToHomeBtn').onclick = () => {
        showOverlay('quoteOverlay');
        setTimeout(() => location.reload(), 3500);
    };

    renderLeaderboard();
</script>
</body>
</html>
